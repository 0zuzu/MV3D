{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/util.js","webpack:///./src/mod_babylon.js","webpack:///./src/mv3d.js","webpack:///./src/mod_mv.js","webpack:///./src/parameters.js","webpack:///./src/blenders.js","webpack:///./src/input.js","webpack:///./src/configuration.js","webpack:///./src/plugin_commands.js","webpack:///./src/tileData.js","webpack:///./src/mapCell.js","webpack:///./src/loadMap.js","webpack:///./src/assets.js","webpack:///./src/characters.js","webpack:///./src/movement.js","webpack:///./src/parallax.js"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","Vector2","Vector3","Color3","Color4","window","BABYLON","makeColor","color","g","b","a","toColor4","canvas","document","createElement","width","height","context","getContext","fillStyle","fillRect","bytes","getImageData","data","relativeNumber","current","relative","test","substr","Number","isNaN","Boolean","falseString","String","S","toUpperCase","values","includes","ms","Promise","resolve","setTimeout","degtorad","deg","Math","PI","radtodeg","rad","tileSize","tileWidth","Game_Map","tileHeight","XAxis","YAxis","ZAxis","v2origin","Scene","Engine","FreeCamera","HemisphericLight","DirectionalLight","SpotLight","PointLight","ShadowGenerator","Vector4","Plane","Node","TransformNode","Texture","StandardMaterial","Mesh","MeshBuilder","FRONTSIDE","BACKSIDE","DOUBLESIDE","PERSPECTIVE_CAMERA","ORTHOGRAPHIC_CAMERA","Camera","FOGMODE_NONE","FOGMODE_EXP","FOGMODE_EXP2","FOGMODE_LINEAR","WORLDSPACE","Space","WORLD","LOCALSPACE","LOCAL","BONE","crop","x","y","w","h","this","getBaseSize","EDGE_FIX","uScale","vScale","uOffset","vOffset","defineProperties","position","undefined","v","z","pitch","rotation","yaw","roll","_order","_scene","sortMeshes","meshSorter","m1","m2","meshes","sort","_addMesh","addMesh","mesh","apply","arguments","_removeMesh","removeMesh","toNumber","mv3d","setupParameters","texture","PIXI","fromCanvas","engine","ANTIALIASING","scene","clearColor","set","cameraStick","cameraNode","parent","camera","fov","FOV","orthoLeft","Graphics","orthoRight","orthoTop","orthoBottom","minZ","maxZ","RENDER_DIST","ambientColor","fogMode","map","cells","characters","setupBlenders","setupInput","setupSpriteMeshes","_width","_height","render","update","lastMapUpdate","performance","now","mapUpdating","updateMap","updateAnimations","updateBlenders","updateCharacters","KEYBOARD_TURN","is1stPerson","Input","isTriggered","blendCameraYaw","setValue","targetValue","playerFaceYaw","KEYBOARD_PITCH","isPressed","blendCameraPitch","min","max","loadData","dfault","$gameVariables","console","warn","cameraMode","startsWith","CAMERA_MODE","saveData","useCurrent","k","getCameraTarget","$gamePlayer","blendCameraTransition","blendCameraDist","blendPanX","blendPanY","$gameMap","isLoopHorizontal","mapWidth","ox","mod","isLoopVertical","mapHeight","oy","dir","floor","setDirection","currentValue","reverse","_graphics_createCanvas","_createCanvas","setup","updateCanvas","_graphics_updateAllElements","_updateAllElements","_graphics_render","_sceneMap_update","Scene_Map","ShaderTilemap","renderWebGL","renderer","_createTilemap","Spriteset_Map","createTilemap","_tilemap","visible","_baseSprite","addChild","Sprite","_sprite_char_setchar","Sprite_Character","setCharacter","character","configurable","_performTransfer","Game_Player","performTransfer","newmap","_newMapId","mapId","clearMap","_onMapLoaded","onMapLoaded","mapLoaded","loadMap","parameters","PluginManager","assign","ORTHOGRAPHIC_DIST","ANIM_DELAY","animDelay","ALPHA_CUTOFF","alphatest","edgefix","antialiasing","WALL_HEIGHT","wallHeight","TABLE_HEIGHT","tableHeight","FRINGE_HEIGHT","fringeHeight","CEILING_HEIGHT","ceilingHeight","LAYER_DIST","layerDist","CELL_SIZE","renderDist","FOG_COLOR","fogColor","FOG_NEAR","fogNear","FOG_FAR","fogFar","AMBIENT_COLOR","LIGHT_HEIGHT","LIGHT_DECAY","LIGHT_DIST","LIGHT_ANGLE","CHARACTER_SHADOWS","characterShadows","SHADOW_SCALE","shadowScale","SHADOW_DIST","shadowDist","keyboardPitch","keyboardTurn","KEYBOARD_STRAFE","keyboardStrafe","REGION_DATA","TTAG_DATA","EVENT_HEIGHT","eventHeight","VEHICLE_BUSH","vehicleBush","BOAT_SETTINGS","JSON","parse","boatSettings","SHIP_SETTINGS","shipSettings","AIRSHIP_SETTINGS","airshipSettings","entry","regions","regionId","ttags","terrainTag","offsetTop","topOffsetX","topOffsetY","offsetSide","sideOffsetX","sideOffsetY","shape","configurationShapes","scale","zoff","big","bushLanding","EVENT_SHAPE","eventShape","cameraTargets","char","time","unshift","length","getTargetString","clearCameraTarget","setCameraTarget","target","targetChar","blendFogColor","ColorBlender","blendFogNear","blendFogFar","cycle","blendCameraHeight","blendAmbientColor","blendSunlightColor","blendSunlightIntensity","reorient","updateCameraMode","char1","isInVehicle","vehicle","char2","_realX","_realY","mv3d_sprite","translate","fogStart","fogEnd","copyFromFloats","speed","Infinity","diff","saveValue","abs","sign","loadValue","storage","storageLocation","ret","getInputDescriptor","menumode","p3mode","p1mode","assignedValue","SceneManager","keyMapper","81","69","87","65","83","68","descriptors","left","rotleft","right","rotright","37","39","getInputDirection","dir4","transformDirectionYaw","_player_updateMove","updateMove","isMoving","_player_move_straight","moveStraight","isMovementSucceeded","raycastPredicate","isEnabled","isVisible","isPickable","isFollower","isPlayer","processMapTouch","TouchInput","_touchCount","intersection","pick","hit","point","pickedPoint","pickedMesh","$gameTemp","setDestination","round","_player_findDirectionTo","findDirectionTo","dirToYaw","tilesetConfigurations","mapConfigurations","lines","readConfigurationBlocks","tileset","note","readLines","match","exec","conf","readConfigurationFunctions","tilesetConfigurationFunctions","tileId","constructTileId","split","mapconf","$dataMap","mapConfigurationFunctions","fog","near","far","light","cameraDist","cameraHeight","cameraPitch","cameraYaw","findBlocks","contents","findTags","line","functionset","configurationFunctions","readConfigurations","toLowerCase","configurationSides","front","back","double","FLAT","TREE","SPRITE","FENCE","CROSS","XCROSS","fringe","float","img","sideId","topId","insideId","offsetInside","recttop","rectside","rectTop","Rectangle","setN","getSetNumber","rectSide","rectInside","transparent","alpha","glow","eventConfigurationFunctions","side","rot","bool","bush","shadow","pos","lamp","intensity","distance","angle","flashlight","flashlightPitch","flashlightYaw","lightHeight","lightOffset","alphaTest","camerayaw","camerapitch","cameradist","cameraheight","cameramode","edge","ceiling","_event_setupPage","Game_Event","setupPage","mv3d_needsConfigure","eventConfigure","_event_init","initialize","createCharacterFor","event","config","readConfigurationTags","locate","mv3d_blenders","lampColor_r","lampColor_g","lampColor_b","lampIntensity","lampDistance","flashlightColor_r","flashlightColor_g","flashlightColor_b","flashlightIntensity","flashlightDistance","flashlightAngle","_pluginCommand","Game_Interpreter","pluginCommand","command","args","pc","PluginCommand","INTERPRETER","FULL_COMMAND","join","filter","CHAR","_eventId","firstChar","TARGET_CHAR","shift","com","_TIME","dist","_cameraTarget","pan","_RELATIVE_BLEND","log","rotationMode","pitchMode","Vehicle","booleanString","_VEHICLE","_fogColor","_fogNear","_fogFar","_lightColor","_lightcolor","AWAIT_CHAR","setupLamp","_lampColor","_lampIntensity","_lampDistance","blendLampColor","blendLampIntensity","blendLampDistance","setupFlashlight","_flashlightColor","_flashlightIntensity","_flashlightDistance","_flashlightAngle","_flashlightYaw","_flashlightPitch","blendFlashlightColor","blendFlashlightIntensity","blendFlashlightDistance","blendFlashlightAngle","blendFlashlightPitch","flashlightTargetYaw","blender","ERROR_CHAR","sleep","self","id","followers","_data","Game_Follower","_followers","indexOf","Game_Vehicle","_vehicles","_spriteset","Tilemap","isAutotile","isTileA1","isTileA2","isTileA3","isTileA5","getTerrainTag","tilesetFlags","options","normalizeAutotileId","offsetBottom","tilemap","getTilemap","bottomId","_isHigherTile","ttag","tagdata","rectBottom","hasInsideConf","hasBottomConf","tileRange","tileData","getTileData","isTileEmpty","defaultHeight","region","isSpecialShape","isWallTile","_isTableTile","layerId","getTileHeight","getTileConfig","getStackHeight","ignorePits","rects","isTable","_drawTile","addRect","sheetId","sx","sy","dx","dy","animX","animY","push","splice","kind","getAutotileKind","ty","isWall","isTileA4","shapes","TILE_ID_A1","SOURCEPLANE_GROUND","pow","SOURCEPLANE_WALL","cx","cy","toString","super","load","loopPos","loopCoords","CreatePlane","sideOrientation","sourcePlane","submeshes","cellWidth","cellHeight","nlnowall","tileConf","realId","isFringeTile","loadTile","loadWalls","loadFence","loadCross","MergeMeshes","configRect","getTileRects","rect","createMesh","material","getCachedTileMaterial","getMaterialOptions","realWallHeight","isFringe","ni","neighborPositions","np","getMapConfig","neededHeight","getFringeHeight","neighborHeight","getCullingHeight","wallPos","atan2","scaling","rotate","npl","npr","leftHeight","rightHeight","bx","by","getAutotileCorner","wallParts","partHeight","sw","sh","isTableTile","ax","az","hasLeftEdge","hasRightEdge","isWaterfallTile","edges","rightSide","tx","textureCache","dispose","materialCache","animatedTextures","loadMapSettings","createCharacters","bounds","top","bottom","cellsToLoad","ix","iy","ceil","cameraCellPos","DistanceSquared","cellpos","loadMapCell","cell","tsName","tilesetNames","getErrorTexture","hasAlpha","onLoadObservable","addOnce","updateSamplingMode","isWaterfall","frameData","errorTexture","bushAlphaTexture","getAlphaFromRGB","processMaterialOptions","getExtraBit","getCachedTileTexture","diffuseTexture","opacityTexture","alphaCutOff","emissiveColor","specularColor","alph","extra","lastAnimUpdate","animXFrame","animYFrame","animDirection","events","vehicles","f","order","sprite","Meshes","clone","SHADOW","shadowTexture","shadowMaterial","spriteOrigin","src","disposeMaterial","bitmap","_texture","onTextureLoaded","_character","charName","charIndex","updateCharacter","updateShape","isVehicle","isBoat","isShip","isAirship","isEvent","elevation","lightOrigin","setupLights","isReady","_tileId","textureSrc","setMaterial","updateFrame","updateScale","_tilesetId","tilesetId","_characterName","characterName","_characterIndex","characterIndex","_isBigCharacter","ImageManager","isBigCharacter","setTileMaterial","px","characterPatternX","py","characterPatternY","isTextureReady","pw","patternWidth","ph","patternHeight","characterBlockX","characterBlockY","setFrame","isObjectCharacter","direction","configScale","getConfig","settings","_type","xscale","yscale","settings_event","settings_event_page","page","comments","list","code","excludedMeshes","makeColorBlender","makeBlender","Zero","exponent","range","diffuse","targetComponents","flashlightOrigin","blendFlashlightYaw","updateFlashlightDirection","setupMesh","flashlightOffset","tan","currentComponents","clazz","isTile","newshape","getShape","geometry","_erased","mv_sprite","_isEnabled","setEnabled","isImageChanged","patternChanged","bushDepth","hasBush","getBushAlphaTexture","useAlphaFromDiffuseTexture","getWalkHeight","updatePosition","updateElevation","updateShadow","updateLights","billboardOffset","sin","cos","multiplyByFloats","newElevation","getFloatHeight","_driving","ascentSpeed","vehicleObstructed","descentSpeed","_altitude","maxAltitude","isJumping","jumpProgress","_jumpCount","_jumpPeak","jumpHeight","jumpDiff","mv3d_jumpHeightEnd","mv3d_jumpHeightStart","_priorityType","hasConfig","shadowVisible","myIndex","other","shadowBase","shadowFadeDist","shadowStrength","setAll","isAnInstance","visibility","methodName","_characterBase_canPass","Game_CharacterBase","canPass","vehicleNotObstructed","strict","isDebugThrough","altitude","posZ","tileHeight2","x2","roundXWithDirection","y2","roundYWithDirection","obstructed","isThrough","tileHeight1","_airship_land_ok","isAirshipLandOk","airship","checkPassage","_player_updateVehicleGetOn","updateVehicleGetOn","_moveSpeed","setMoveSpeed","_charBase_jump","jump","xPlus","yPlus","gameMap_parallaxOx","parallaxOx","_parallaxLoopX","gameMap_parallaxOy","parallaxOy","_parallaxLoopY","setDisplayPos","scrollUp","scrollDown","scrollLeft","scrollRight","updateScroll","_displayX","_displayY","isNearTheScreen"],"mappings":"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","file":"mv3d-babylon.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","\r\nconst {Vector2,Vector3,Color3,Color4} = window.BABYLON;\r\n\r\nexport const makeColor = color=>{\r\n\tif (typeof color === 'number'){\r\n\t\treturn {\r\n\t\t\tr: (color>>16)/255,\r\n\t\t\tg: (color>>8&255)/255,\r\n\t\t\tb: (color&255)/255,\r\n\t\t\ta: 1,\r\n\t\t};\r\n\t}else if(color instanceof Color3){\r\n\t\treturn color.toColor4();\r\n\t}else if(color instanceof Color4){\r\n\t\treturn color;\r\n\t}else{\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width=1; canvas.height=1;\r\n\t\tconst context = canvas.getContext('2d');\r\n\t\tcontext.fillStyle = color; context.fillRect(0,0,1,1);\r\n\t\tconst bytes = context.getImageData(0,0,1,1).data;\r\n\t\treturn new Color4(bytes[0]/255,bytes[1]/255,bytes[2]/255,bytes[3]/255);\r\n\t}\r\n}\r\n\r\n\r\nexport const hexNumber=n=>{\r\n\tn=String(n);\r\n\tif(n.startsWith('#')){\r\n\t\tn=n.substr(1);\r\n\t}\r\n\treturn Number.parseInt(n,16);\r\n};\r\n\r\nexport const relativeNumber=(current,n)=>{\r\n\tif(n===''){ return +current; }\r\n\tconst relative = /^[+]/.test(n);\r\n\tif(relative){n=n.substr(1);}\r\n\tn=Number(n);\r\n\tif(Number.isNaN(n)){ return +current; }\r\n\tif(relative){\r\n\t\treturn +current+n;\r\n\t}else{\r\n\t\treturn +n;\r\n\t}\r\n};\r\n\r\nexport const booleanString=s=>{\r\n\treturn Boolean(falseString(s));\r\n}\r\nexport const falseString=s=>{\r\n\tif(!s){ return false; }\r\n\tif(typeof s !=='string'){ s=String(s); }\r\n\tconst S=s.toUpperCase();\r\n\tif(falseString.values.includes(S)){\r\n\t\treturn false;\r\n\t}\r\n\treturn s;\r\n}\r\nfalseString.values=['OFF','FALSE','UNDEFINED','NULL','DISABLE','DISABLED'];\r\n\r\nexport const sleep=(ms=0)=>new Promise(resolve=>setTimeout(resolve,ms));\r\nexport const degtorad=deg=>deg*Math.PI/180;\r\nexport const radtodeg=rad=>rad*180/Math.PI;\r\n\r\nexport const tileSize=()=>tileWidth();\r\nexport const tileWidth=()=>Game_Map.prototype.tileWidth();\r\nexport const tileHeight=()=>Game_Map.prototype.tileHeight();\r\n\r\n// useful consts\r\nexport const XAxis = new Vector3(1,0,0);\r\nexport const YAxis = new Vector3(0,1,0);\r\nexport const ZAxis = new Vector3(0,0,1);\r\nexport const v2origin = new Vector2(0,0);\r\nexport const v3origin = new Vector3(0,0,0);","const BABYLON = window.BABYLON;\r\nexport const {\r\n\tScene,\r\n\tEngine,\r\n\tFreeCamera,\r\n\tHemisphericLight,\r\n\tDirectionalLight,\r\n\tSpotLight,\r\n\tPointLight,\r\n\tShadowGenerator,\r\n\tVector2,\r\n\tVector3,\r\n\tVector4,\r\n\tColor3,\r\n\tColor4,\r\n\tPlane,\r\n\tNode,\r\n\tTransformNode,\r\n\tTexture,\r\n\tStandardMaterial,\r\n\tMesh,\r\n\tMeshBuilder,\r\n} = BABYLON;\r\n\r\nexport const {\r\n\tFRONTSIDE,BACKSIDE,DOUBLESIDE,\r\n} = Mesh;\r\n\r\nexport const {\r\n\tPERSPECTIVE_CAMERA,\r\n\tORTHOGRAPHIC_CAMERA,\r\n} = BABYLON.Camera;\r\n\r\nexport const{\r\n\tFOGMODE_NONE,\r\n\tFOGMODE_EXP,\r\n\tFOGMODE_EXP2,\r\n\tFOGMODE_LINEAR,\r\n} = Scene;\r\n\r\nexport const WORLDSPACE = BABYLON.Space.WORLD,\r\n             LOCALSPACE = BABYLON.Space.LOCAL,\r\n              BONESPACE = BABYLON.Space.BONE;\r\n\r\nimport mv3d from './mv3d.js';\r\nimport { radtodeg, degtorad } from './util.js';\r\n\r\nTexture.prototype.crop=function(x=0,y=0,w=0,h=0){\r\n\tconst { width, height } = this.getBaseSize();\r\n\tif(!w)w=width-x;\r\n\tif(!h)h=height-y;\r\n\tif(mv3d.EDGE_FIX){ x+=mv3d.EDGE_FIX;y+=mv3d.EDGE_FIX;w-=mv3d.EDGE_FIX*2;h-=mv3d.EDGE_FIX*2; }\r\n\tthis.uScale=w/width;\r\n\tthis.vScale=h/height;\r\n\tthis.uOffset=x/width;\r\n\tthis.vOffset=1-y/height-this.vScale;\r\n}\r\n\r\nObject.defineProperties(Node.prototype,{\r\n\tx:{\r\n\t\tget(){ return this.position?this.position.x:undefined; },\r\n\t\tset(v){ if(this.position){ this.position.x=v; } },\r\n\t},\r\n\ty:{\r\n\t\tget(){ return this.position?-this.position.z:undefined; },\r\n\t\tset(v){ if(this.position){ this.position.z=-v; } },\r\n\t},\r\n\tz:{\r\n\t\tget(){ return this.position?this.position.y:undefined; },\r\n\t\tset(v){ if(this.position){ this.position.y=v; } },\r\n\t},\r\n\r\n\tpitch:{\r\n\t\tget(){ return this.rotation?-radtodeg(this.rotation.x):undefined; },\r\n\t\tset(v){ if(this.rotation){ this.rotation.x=-degtorad(v); } },\r\n\t},\r\n\tyaw:{\r\n\t\tget(){ return this.rotation?-radtodeg(this.rotation.y):undefined; },\r\n\t\tset(v){  if(this.rotation){ this.rotation.y=-degtorad(v); } },\r\n\t},\r\n\troll:{\r\n\t\tget(){ return this.rotation?-radtodeg(this.rotation.z):undefined; },\r\n\t\tset(v){  if(this.rotation){ this.rotation.z=-degtorad(v); } },\r\n\t},\r\n});\r\n\r\n// mesh sorting\r\n\r\nObject.defineProperty(Mesh.prototype,'order',{\r\n\tget(){ return this._order; },\r\n\tset(v){ this._order=v; this._scene.sortMeshes(); }\r\n});\r\nconst meshSorter=(m1,m2)=>(m1._order|0)-(m2._order|0);\r\nScene.prototype.sortMeshes=function(){\r\n\tthis.meshes.sort(meshSorter);\r\n}\r\nconst _addMesh = Scene.prototype.addMesh;\r\nScene.prototype.addMesh=function(mesh){\r\n\t_addMesh.apply(this,arguments);\r\n\tif(typeof mesh._order==='number'){\r\n\t\tthis.sortMeshes();\r\n\t}\r\n}\r\nconst _removeMesh = Scene.prototype.removeMesh;\r\nScene.prototype.removeMesh=function(mesh){\r\n\t_removeMesh.apply(this,arguments);\r\n\tthis.sortMeshes();\r\n}\r\n\r\n// color\r\nColor3.prototype.toNumber=Color4.prototype.toNumber=function(){return this.r*255<<16|this.g*255<<8|this.b*255;}","import { Engine, Scene, HemisphericLight, TransformNode, FreeCamera, Node, Vector2, Vector3, Color3, FOGMODE_LINEAR, DirectionalLight, ShadowGenerator, ORTHOGRAPHIC_CAMERA, PERSPECTIVE_CAMERA } from \"./mod_babylon.js\";\r\nimport { v3origin, degtorad, tileSize } from \"./util.js\";\r\n\r\n\r\nconst mv3d = {\r\n\r\n\tsetup(){\r\n\t\tthis.setupParameters();\r\n\r\n\t\tthis.canvas = document.createElement('canvas');\r\n\t\tthis.texture = PIXI.Texture.fromCanvas(this.canvas);\r\n\t\tthis.engine = new Engine(this.canvas,this.ANTIALIASING);\r\n\t\tthis.scene = new Scene(this.engine);\r\n\t\t//this.scene.clearColor.a=0;\r\n\t\tthis.scene.clearColor.set(0,0,0,0);\r\n\r\n\t\tthis.cameraStick = new TransformNode(\"cameraStick\",this.scene);\r\n\t\tthis.cameraNode = new TransformNode(\"cameraNode\",this.scene);\r\n\t\tthis.cameraNode.parent=this.cameraStick;\r\n\t\tthis.camera = new FreeCamera(\"camera\",new Vector3(0,0,0),this.scene);\r\n\t\tthis.camera.parent=this.cameraNode;\r\n\t\tthis.camera.fov=degtorad(mv3d.FOV);\r\n\t\tthis.camera.orthoLeft=-Graphics.width/2/tileSize();\r\n\t\tthis.camera.orthoRight=Graphics.width/2/tileSize();\r\n\t\tthis.camera.orthoTop=Graphics.height/2/tileSize();\r\n\t\tthis.camera.orthoBottom=-Graphics.height/2/tileSize();\r\n\t\tthis.camera.minZ=0.1;\r\n\t\tthis.camera.maxZ=this.RENDER_DIST;\r\n\r\n\t\t//this.sunlight = new DirectionalLight('sunlight', new Vector3(-1,-1,1), this.scene);\r\n\t\t//this.shadowGenerator = new ShadowGenerator(1024,this.sunlight);\r\n\r\n\t\tthis.scene.ambientColor = new Color3(1,1,1);\r\n\t\tthis.scene.fogMode=FOGMODE_LINEAR;\r\n\r\n\t\tthis.map = new Node(\"map\",this.scene);\r\n\t\tthis.cells={};\r\n\t\tthis.characters=[];\r\n\r\n\t\tthis.setupBlenders();\r\n\t\t//this.updateBlenders(true);\r\n\t\tthis.setupInput();\r\n\r\n\t\tthis.setupSpriteMeshes();\r\n\t},\r\n\r\n\tupdateCanvas(){\r\n\t\tthis.canvas.width = Graphics._width;\r\n\t\tthis.canvas.height = Graphics._height;\r\n\t},\r\n\r\n\trender(){\r\n\t\tthis.scene.render();\r\n\t\tthis.texture.update();\r\n\t},\r\n\r\n\tlastMapUpdate:0,\r\n\tupdate(){\r\n\t\tif( performance.now()-this.lastMapUpdate > 1000 && !this.mapUpdating ){\r\n\t\t\tthis.updateMap();\r\n\t\t\tthis.lastMapUpdate=performance.now();\r\n\t\t}\r\n\r\n\t\tthis.updateAnimations();\r\n\r\n\t\tthis.updateBlenders();\r\n\r\n\t\tthis.updateCharacters();\r\n\r\n\t\t// input\r\n\t\tif( mv3d.KEYBOARD_TURN || this.is1stPerson() ){\r\n\t\t\tif(Input.isTriggered('rotleft')){\r\n\t\t\t\tthis.blendCameraYaw.setValue(this.blendCameraYaw.targetValue()+90,0.5);\r\n\t\t\t}else if(Input.isTriggered('rotright')){\r\n\t\t\t\tthis.blendCameraYaw.setValue(this.blendCameraYaw.targetValue()-90,0.5);\r\n\t\t\t}\r\n\t\t\tif(this.is1stPerson()&&(Input.isTriggered('rotleft')||Input.isTriggered('rotright'))){\r\n\t\t\t\tthis.playerFaceYaw();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif( mv3d.KEYBOARD_PITCH ){\r\n\t\t\tif(Input.isPressed('pageup')&&Input.isPressed('pagedown')){\r\n\t\t\t\t// do nothing\r\n\t\t\t}else if(Input.isPressed('pageup')){\r\n\t\t\t\tthis.blendCameraPitch.setValue(Math.min(180,this.blendCameraPitch.targetValue()+1.5),0.1);\r\n\t\t\t}else if(Input.isPressed('pagedown')){\r\n\t\t\t\tthis.blendCameraPitch.setValue(Math.max(0,this.blendCameraPitch.targetValue()-1.5),0.1);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (const key in this.cells){\r\n\t\t\tthis.cells[key].update();\r\n\t\t}\r\n\t},\r\n\r\n\tloadData(key,dfault){\r\n\t\tif(!$gameVariables || !$gameVariables.mv3d || !(key in $gameVariables.mv3d)){ return dfault; }\r\n\t\treturn $gameVariables.mv3d[key];\r\n\t},\r\n\tsaveData(key,value){\r\n\t\tif(!$gameVariables){ return console.warn(`MV3D: Couldn't save data ${key}:${value}`); }\r\n\t\tif(!$gameVariables.mv3d){ $gameVariables.mv3d={}; }\r\n\t\t$gameVariables.mv3d[key]=value;\r\n\t},\r\n\r\n\tupdateCameraMode(){\r\n\t\tconst mode = this.cameraMode;\r\n\t\tif(mode.startsWith('O')){\r\n\t\t\tif(this.camera.mode!==ORTHOGRAPHIC_CAMERA){ this.camera.mode=ORTHOGRAPHIC_CAMERA; }\r\n\t\t}else{\r\n\t\t\tif(this.camera.mode!==PERSPECTIVE_CAMERA){ this.camera.mode=PERSPECTIVE_CAMERA; }\r\n\t\t}\r\n\t},\r\n\tget cameraMode(){\r\n\t\treturn this.loadData('cameraMode',this.CAMERA_MODE).toUpperCase();\r\n\t},\r\n\tset cameraMode(v){\r\n\t\tv = String(v).toUpperCase().startsWith('O') ? 'ORTHOGRAPHIC' : 'PERSPECTIVE' ;\r\n\t\tthis.saveData('cameraMode',v);\r\n\t\tthis.updateBlenders(true);\r\n\t},\r\n\r\n\tis1stPerson(useCurrent){\r\n\t\tconst k = useCurrent?'currentValue':'targetValue';\r\n\t\treturn this.getCameraTarget()===$gamePlayer && this.blendCameraTransition[k]()<=0\r\n\t\t&& this.blendCameraDist[k]()<=0 && this.blendPanX[k]()===0 && this.blendPanY[k]()===0;\r\n\t},\r\n\r\n\tloopCoords(x,y){\r\n\t\tif($gameMap.isLoopHorizontal()){\r\n\t\t\tconst mapWidth=$gameMap.width();\r\n\t\t\tconst ox = this.cameraStick.x - mapWidth/2;\r\n\t\t\tx=(x-ox).mod(mapWidth)+ox;\r\n\t\t}\r\n\t\tif($gameMap.isLoopVertical()){\r\n\t\t\tconst mapHeight=$gameMap.height();\r\n\t\t\tconst oy = this.cameraStick.y - mapHeight/2;\r\n\t\t\ty=(y-oy).mod(mapHeight)+oy;\r\n\t\t}\r\n\t\treturn new Vector2(x,y);\r\n\t},\r\n\t\r\n\tplayerFaceYaw(){\r\n\t\tlet dir = Math.floor((-mv3d.blendCameraYaw.targetValue()+45)/90).mod(4);\r\n\t\tif(dir>1){ dir+=(dir+1)%2*2-1; }\r\n\t\tdir=10-(dir*2+2);\r\n\t\t$gamePlayer.setDirection(dir);\r\n\t},\r\n\r\n\tdirToYaw(dir){\r\n\t\tlet yaw = dir/2-1;\r\n\t\tif(yaw>1){ yaw+=(yaw+1)%2*2-1; }\r\n\t\tyaw=yaw*-90+180;\r\n\t\treturn yaw;\r\n\t},\r\n\t\r\n\ttransformDirectionYaw(dir,yaw=this.blendCameraYaw.currentValue(),reverse=false){\r\n\t\tif(dir==0){ return 0; }\r\n\t\tdir = dir/2-1;\r\n\t\tif(dir>1){ dir+=(dir+1)%2*2-1; }\r\n\t\tconst c = Math.floor((yaw+45)/90);\r\n\t\tif(reverse){\r\n\t\t\tdir=(dir-c).mod(4);\r\n\t\t}else{\r\n\t\t\tdir=(dir+c).mod(4);\r\n\t\t}\r\n\t\tif(dir>1){ dir+=(dir+1)%2*2-1; }\r\n\t\treturn dir*2+2;\r\n\t},\r\n\r\n}\r\nwindow.mv3d=mv3d;\r\nexport default mv3d;","import mv3d from './mv3d.js';\r\n\r\nconst _graphics_createCanvas=Graphics._createCanvas;\r\nGraphics._createCanvas = function() {\r\n\tmv3d.setup();\r\n\tmv3d.updateCanvas();\r\n\t_graphics_createCanvas.apply(this,arguments);\r\n};\r\n\r\nconst _graphics_updateAllElements=Graphics._updateAllElements;\r\nGraphics._updateAllElements = function() {\r\n\t_graphics_updateAllElements.apply(this,arguments);\r\n\tmv3d.updateCanvas();\r\n};\r\n\r\nconst _graphics_render=Graphics.render;\r\nGraphics.render=function(){\r\n\tmv3d.render();\r\n\t_graphics_render.apply(this,arguments);\r\n};\r\n\r\nconst _sceneMap_update=Scene_Map.prototype.update;\r\nScene_Map.prototype.update = function(){\r\n\t_sceneMap_update.apply(this,arguments);\r\n\tmv3d.update();\r\n}\r\n\r\nShaderTilemap.prototype.renderWebGL = function(renderer) {};\r\n\r\nconst _createTilemap=Spriteset_Map.prototype.createTilemap;\r\nSpriteset_Map.prototype.createTilemap=function(){\r\n\t_createTilemap.apply(this,arguments);\r\n\tthis._tilemap.visible=false;\r\n\tthis._baseSprite.addChild( new PIXI.Sprite(mv3d.texture) );\r\n};\r\n\r\nconst _sprite_char_setchar = Sprite_Character.prototype.setCharacter;\r\nSprite_Character.prototype.setCharacter = function(character) {\r\n\t_sprite_char_setchar.apply(this,arguments);\r\n\tObject.defineProperty(character,'mv_sprite',{\r\n\t\tvalue:this,\r\n\t\tconfigurable:true,\r\n\t});\r\n};\r\n\r\n// Player Transfer\r\n\r\nconst _performTransfer=Game_Player.prototype.performTransfer;\r\nGame_Player.prototype.performTransfer = function() {\r\n\tconst newmap = this._newMapId !== $gameMap.mapId();\r\n\tif(newmap){\r\n\t\tmv3d.clearMap();\r\n\t}\r\n\t_performTransfer.apply(this,arguments);\r\n};\r\n\r\n// On Map Load\r\n\r\nconst _onMapLoaded=Scene_Map.prototype.onMapLoaded;\r\nScene_Map.prototype.onMapLoaded=function(){\r\n\t_onMapLoaded.apply(this,arguments);\r\n\tif(!mv3d.mapLoaded){\r\n\t\tmv3d.loadMap();\r\n\t}\r\n\tmv3d.updateBlenders(true);\r\n};","import mv3d from './mv3d.js';\r\nimport { hexNumber,booleanString,falseString, makeColor } from './util.js';\r\nimport { Vector2 } from './mod_babylon.js';\r\n\r\nconst parameters = PluginManager.parameters('mv3d-babylon');\r\nexport default parameters;\r\n\r\nObject.assign(mv3d,{\r\n\tCAMERA_MODE:\"PERSPECTIVE\",\r\n\tORTHOGRAPHIC_DIST:100,\r\n\r\n\tANIM_DELAY:Number(parameters.animDelay),\r\n\tALPHA_CUTOFF:Math.max(0.01,parameters.alphatest),\r\n\r\n\tEDGE_FIX: Number(parameters.edgefix),\r\n\tANTIALIASING: booleanString(parameters.antialiasing),\r\n\tFOV:Number(parameters.fov),\r\n\r\n\tWALL_HEIGHT:Number(parameters.wallHeight),\r\n\tTABLE_HEIGHT:Number(parameters.tableHeight),\r\n\tFRINGE_HEIGHT:Number(parameters.fringeHeight),\r\n\tCEILING_HEIGHT:Number(parameters.ceilingHeight),\r\n\tLAYER_DIST:Number(parameters.layerDist),\r\n\r\n\tCELL_SIZE:10,\r\n\tRENDER_DIST: Number(parameters.renderDist),\r\n\r\n\tFOG_COLOR: makeColor(parameters.fogColor).toNumber(),\r\n\tFOG_NEAR: Number(parameters.fogNear),\r\n\tFOG_FAR: Number(parameters.fogFar), \r\n\tAMBIENT_COLOR: makeColor(parameters.ambientColor).toNumber(),\r\n\r\n\r\n\tLIGHT_HEIGHT: 0.5,\r\n\tLIGHT_DECAY: 1,\r\n\tLIGHT_DIST: 3,\r\n\tLIGHT_ANGLE: 45,\r\n\r\n\tCHARACTER_SHADOWS:booleanString(parameters.characterShadows),\r\n\tSHADOW_SCALE:Number(parameters.shadowScale),\r\n\tSHADOW_DIST:Number(parameters.shadowDist),\r\n\r\n\tKEYBOARD_PITCH: booleanString(parameters.keyboardPitch),\r\n\tKEYBOARD_TURN: booleanString(parameters.keyboardTurn),\r\n\tKEYBOARD_STRAFE: booleanString(parameters.keyboardStrafe),\r\n\r\n\tREGION_DATA:{},\r\n\tTTAG_DATA:{},\r\n\r\n\tEVENT_HEIGHT:Number(parameters.eventHeight),\r\n\tVEHICLE_BUSH:booleanString(parameters.vehicleBush),\r\n\tBOAT_SETTINGS:JSON.parse(parameters.boatSettings),\r\n\tSHIP_SETTINGS:JSON.parse(parameters.shipSettings),\r\n\tAIRSHIP_SETTINGS:JSON.parse(parameters.airshipSettings),\r\n\r\n\r\n\tsetupParameters(){\r\n\t\tfor (let entry of JSON.parse(parameters.regions)){\r\n\t\t\tentry=JSON.parse(entry);\r\n\t\t\tthis.REGION_DATA[entry.regionId]={\r\n\t\t\t\theight: Number(entry.height),\r\n\t\t\t};\r\n\t\t}\r\n\t\tfor (let entry of JSON.parse(parameters.ttags)){\r\n\t\t\tentry=JSON.parse(entry);\r\n\t\t\tthis.TTAG_DATA[entry.terrainTag]={\r\n\t\t\t\theight: Number(entry.height),\r\n\t\t\t\toffsetTop: new Vector2(Number(entry.topOffsetX),Number(entry.topOffsetY)),\r\n\t\t\t\toffsetSide: new Vector2(Number(entry.sideOffsetX),Number(entry.sideOffsetY)),\r\n\t\t\t\tshape: this.configurationShapes[entry.shape.toUpperCase()],\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tthis.BOAT_SETTINGS.scale=Number(this.BOAT_SETTINGS.scale);\r\n\t\tthis.BOAT_SETTINGS.zoff=Number(this.BOAT_SETTINGS.zoff);\r\n\t\tthis.BOAT_SETTINGS.big=booleanString(this.BOAT_SETTINGS.big);\r\n\t\tthis.SHIP_SETTINGS.scale=Number(this.SHIP_SETTINGS.scale);\r\n\t\tthis.SHIP_SETTINGS.zoff=Number(this.SHIP_SETTINGS.zoff);\r\n\t\tthis.SHIP_SETTINGS.big=booleanString(this.SHIP_SETTINGS.big);\r\n\t\tthis.AIRSHIP_SETTINGS.scale=Number(this.AIRSHIP_SETTINGS.scale);\r\n\t\tthis.AIRSHIP_SETTINGS.height=Number(this.AIRSHIP_SETTINGS.height);\r\n\t\tthis.AIRSHIP_SETTINGS.shadowScale=Number(this.AIRSHIP_SETTINGS.shadowScale);\r\n\t\tthis.AIRSHIP_SETTINGS.shadowDist=Number(this.AIRSHIP_SETTINGS.shadowDist);\r\n\t\tthis.AIRSHIP_SETTINGS.big=booleanString(this.AIRSHIP_SETTINGS.big);\r\n\t\tthis.AIRSHIP_SETTINGS.bushLanding=booleanString(this.AIRSHIP_SETTINGS.bushLanding);\r\n\r\n\r\n\t\tthis.EVENT_SHAPE=this.configurationShapes[parameters.eventShape.toUpperCase()];\r\n\t},\r\n});","import mv3d from './mv3d.js';\r\nimport { hexNumber, ZAxis } from \"./util.js\";\r\nimport parameters from './parameters.js';\r\nimport { ORTHOGRAPHIC_CAMERA, LOCALSPACE } from './mod_babylon.js';\r\n\r\nObject.assign(mv3d,{\r\n\r\n\tcameraTargets:[],\r\n\tgetCameraTarget(){\r\n\t\treturn this.cameraTargets[0];\r\n\t},\r\n\tsetCameraTarget(char,time){\r\n\t\tif(!char){ this.cameraTargets.length=0; return; }\r\n\t\tthis.cameraTargets.unshift(char);\r\n\t\tif(this.cameraTargets.length>2){ this.cameraTargets.length=2; }\r\n\t\tthis.saveData('cameraTarget',this.getTargetString(char));\r\n\t\tthis.blendCameraTransition.value=1;\r\n\t\tthis.blendCameraTransition.setValue(0,time);\r\n\t},\r\n\tclearCameraTarget(){\r\n\t\tthis.cameraTargets.length=0;\r\n\t},\r\n\tresetCameraTarget(){\r\n\t\tthis.clearCameraTarget();\r\n\t\tthis.setCameraTarget($gamePlayer,0);\r\n\t},\r\n\trememberCameraTarget(){\r\n\t\tconst target = this.loadData('cameraTarget');\r\n\t\tif(target){\r\n\t\t\tthis.setCameraTarget(this.targetChar(target),0);\r\n\t\t}\r\n\t},\r\n\r\n\tsetupBlenders(){\r\n\t\tthis.blendFogColor = new ColorBlender('fogColor',this.FOG_COLOR);\r\n\t\tthis.blendFogNear = new Blender('fogNear',this.FOG_NEAR);\r\n\t\tthis.blendFogFar = new Blender('fogFar',this.FOG_FAR);\r\n\t\tthis.blendCameraYaw = new Blender('cameraYaw',0);\r\n\t\tthis.blendCameraYaw.cycle=360;\r\n\t\tthis.blendCameraPitch = new Blender('cameraPitch',60);\r\n\t\tthis.blendCameraPitch.min=0;\r\n\t\tthis.blendCameraPitch.max=180;\r\n\t\tthis.blendCameraDist = new Blender('cameraDist',10);\r\n\t\tthis.blendCameraHeight = new Blender('cameraHeight',0.7);\r\n\t\tthis.blendAmbientColor = new ColorBlender('ambientColor',this.AMBIENT_COLOR);\r\n\t\tthis.blendSunlightColor = new ColorBlender('light_color',0xffffff);\r\n\t\tthis.blendSunlightIntensity = new Blender('light_intensity',1);\r\n\t\tthis.blendPanX = new Blender('panX',0);\r\n\t\tthis.blendPanY = new Blender('panY',0);\r\n\t\tthis.blendCameraTransition = new Blender('cameraTransition',0);\r\n\t},\r\n\r\n    updateBlenders(reorient){\r\n\t\tthis.updateCameraMode();\r\n\t\t// camera target & pan\r\n\t\tif(!this.cameraTargets.length){\r\n\t\t\tif($gamePlayer){\r\n\t\t\t\tthis.cameraTargets[0]=$gamePlayer;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(this.blendCameraTransition.update() && this.cameraTargets.length>=2){\r\n\t\t\tconst t = this.blendCameraTransition.currentValue();\r\n\t\t\tlet char1=this.cameraTargets[0];\r\n\t\t\tif(char1===$gamePlayer&&$gamePlayer.isInVehicle()){ char1=$gamePlayer.vehicle(); }\r\n\t\t\tlet char2=this.cameraTargets[1];\r\n\t\t\tif(char2===$gamePlayer&&$gamePlayer.isInVehicle()){ char2=$gamePlayer.vehicle(); }\r\n\t\t\tthis.cameraStick.x = char1._realX*(1-t) + char2._realX*t;\r\n\t\t\tthis.cameraStick.y = char1._realY*(1-t) + char2._realY*t;\r\n\t\t\tif(char1.mv3d_sprite&&char2.mv3d_sprite){\r\n\t\t\t\tthis.cameraStick.z = char1.mv3d_sprite.z*(1-t) + char2.mv3d_sprite.z*t;\r\n\t\t\t}else if(char1.mv3d_sprite){\r\n\t\t\t\tthis.cameraStick.z=char1.mv3d_sprite.z;\r\n\t\t\t}\r\n\t\t}else if(this.cameraTargets.length){\r\n\t\t\tlet char = this.getCameraTarget();\r\n\t\t\tif(char===$gamePlayer&&$gamePlayer.isInVehicle()){ char=$gamePlayer.vehicle(); }\r\n\t\t\tthis.cameraStick.x=char._realX;\r\n\t\t\tthis.cameraStick.y=char._realY;\r\n\t\t\tif(char.mv3d_sprite){\r\n\t\t\t\tthis.cameraStick.z=char.mv3d_sprite.z;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.blendPanX.update();\r\n\t\tthis.blendPanY.update();\r\n\t\tthis.cameraStick.x+=this.blendPanX.currentValue();\r\n\t\tthis.cameraStick.y+=this.blendPanY.currentValue();\r\n\r\n\t\t// camera yaw, pitch, dist & height\r\n\t\tif(reorient|this.blendCameraPitch.update()|this.blendCameraYaw.update()\r\n\t\t|this.blendCameraDist.update()|this.blendCameraHeight.update()){\r\n\t\t\tthis.cameraNode.pitch = this.blendCameraPitch.currentValue()-90;\r\n\t\t\tthis.cameraNode.yaw = this.blendCameraYaw.currentValue();\r\n\t\t\tthis.cameraNode.position.set(0,0,0);\r\n\t\t\tthis.cameraNode.translate(ZAxis,-this.blendCameraDist.currentValue(),LOCALSPACE);\r\n\t\t\tif(this.camera.mode===ORTHOGRAPHIC_CAMERA){\r\n\t\t\t\t//this.camera.zoom=10/this.blendCameraDist.currentValue();\r\n\t\t\t\t//this.camera.updateProjectionMatrix();\r\n\t\t\t\tthis.camera.maxZ=this.RENDER_DIST;\r\n\t\t\t\tthis.camera.minZ=-this.RENDER_DIST;\r\n\t\t\t}else{\r\n\t\t\t\t\r\n\t\t\t\tif(this.cameraNode.z<0){ this.cameraNode.z=0; }\r\n\t\t\t\tthis.camera.maxZ=this.RENDER_DIST;\r\n\t\t\t\tthis.camera.minZ=0.1;\r\n\t\t\t}\r\n\t\t\tthis.cameraNode.z += this.blendCameraHeight.currentValue();\r\n\t\t}\r\n\r\n\t\t//fog\r\n\t\tif(reorient|this.blendFogColor.update()|this.blendFogNear.update()|this.blendFogFar.update()){\r\n\t\t\tthis.scene.fogStart=this.blendFogNear.currentValue();\r\n\t\t\tthis.scene.fogEnd=this.blendFogFar.currentValue();\r\n\t\t\tthis.scene.fogColor.copyFromFloats(\r\n\t\t\t\tthis.blendFogColor.r.currentValue()/255,\r\n\t\t\t\tthis.blendFogColor.g.currentValue()/255,\r\n\t\t\t\tthis.blendFogColor.b.currentValue()/255,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\t//light\r\n\t\tif(reorient|this.blendAmbientColor.update()){\r\n\t\t\tthis.scene.ambientColor.copyFromFloats(\r\n\t\t\t\tthis.blendAmbientColor.r.currentValue()/255,\r\n\t\t\t\tthis.blendAmbientColor.g.currentValue()/255,\r\n\t\t\t\tthis.blendAmbientColor.b.currentValue()/255,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t},\r\n\r\n});\r\n\r\n\r\nexport class Blender{\r\n\tconstructor(key,dfault){\r\n\t\tthis.key=key;\r\n\t\tthis.dfault=mv3d.loadData(key,dfault);\r\n\t\tthis.value=dfault;\r\n\t\tthis.speed=1;\r\n\t\tthis.max=Infinity;\r\n\t\tthis.min=-Infinity;\r\n\t\tthis.cycle=false;\r\n\t}\r\n\tsetValue(target,time=0){\r\n\t\ttarget = Math.min(this.max,Math.max(this.min,target));\r\n\t\tlet diff = target - this.value;\r\n\t\tif(!diff){ return; }\r\n\t\tthis.saveValue(this.key,target);\r\n\t\tif(this.cycle){\r\n\t\t\twhile ( Math.abs(diff)>this.cycle/2 ){\r\n\t\t\t\tthis.value += Math.sign(diff)*this.cycle;\r\n\t\t\t\tdiff = target - this.value;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.speed = Math.abs(diff)/(60*time);\r\n\t}\r\n\tcurrentValue(){ return this.value; }\r\n\ttargetValue(){ return this.loadValue(this.key); }\r\n\tdefaultValue(){ return this.dfault; }\r\n\tupdate(){\r\n\t\tconst target = this.targetValue();\r\n\t\tif(this.value===target){ return false; }\r\n\t\tconst diff = target - this.value;\r\n\t\tif(this.speed > Math.abs(diff)){\r\n\t\t\tthis.value=target;\r\n\t\t}else{\r\n\t\t\tthis.value+=this.speed*Math.sign(diff);\r\n\t\t}\r\n\t\treturn true;\r\n\t}\r\n\tstorageLocation(){\r\n\t\tif(!$gameVariables){\r\n\t\t\tconsole.warn(`MV3D: Couldn't get Blend storage location.`);\r\n\t\t\treturn {};\r\n\t\t}\r\n\t\tif(!$gameVariables.mv3d){ $gameVariables.mv3d = {}; }\r\n\t\treturn $gameVariables.mv3d;\r\n\t}\r\n\tloadValue(key){\r\n\t\tconst storage = this.storageLocation();\r\n\t\tif(!(key in storage)){ return this.dfault; }\r\n\t\treturn storage[key];\r\n\t}\r\n\tsaveValue(key,value){\r\n\t\tconst storage = this.storageLocation();\r\n\t\tstorage[key]=value;\r\n\t}\r\n}\r\n\r\nexport class ColorBlender{\r\n\tconstructor(key,dfault){\r\n\t\tthis.dfault=dfault;\r\n\t\tthis.r=new Blender(`${key}_r`,dfault>>16);\r\n\t\tthis.g=new Blender(`${key}_g`,dfault>>8&0xff);\r\n\t\tthis.b=new Blender(`${key}_b`,dfault&0xff);\r\n\t}\r\n\tsetValue(color,time){\r\n\t\tthis.r.setValue(color>>16,time);\r\n\t\tthis.g.setValue(color>>8&0xff,time);\r\n\t\tthis.b.setValue(color&0xff,time);\r\n\t}\r\n\tcurrentValue(){\r\n\t\treturn this.r.value<<16|this.g.value<<8|this.b.value;\r\n\t}\r\n\ttargetValue(){\r\n\t\treturn this.r.targetValue()<<16|this.g.targetValue()<<8|this.b.targetValue();\r\n\t}\r\n\tdefaultValue(){ return this.dfault; }\r\n\tupdate(){\r\n\t\tlet ret=0;\r\n\t\tret|=this.r.update();\r\n\t\tret|=this.g.update();\r\n\t\tret|=this.b.update();\r\n\t\treturn Boolean(ret);\r\n\t}\r\n\tget storageLocation(){ return this.r.storageLocation; }\r\n\tset storageLocation(v){\r\n\t\tthis.r.storageLocation=v;\r\n\t\tthis.g.storageLocation=v;\r\n\t\tthis.b.storageLocation=v;\r\n\t}\r\n\tcurrentComponents(){\r\n\t\treturn [this.r.currentValue()/255,this.g.currentValue()/255,this.b.currentValue()/255];\r\n\t}\r\n\ttargetComponents(){\r\n\t\treturn [this.r.targetValue()/255,this.g.targetValue()/255,this.b.targetValue()/255];\r\n\t}\r\n}","import mv3d from './mv3d.js';\r\n\r\nObject.assign(Input.keyMapper,{\r\n\t81:'rotleft',  // Q\r\n\t69:'rotright', // E\r\n\t87:'up',       // W\r\n\t65:'left',     // A\r\n\t83:'down',     // S\r\n\t68:'right',    // D\r\n});\r\n\r\nmv3d.setupInput=function(){\r\n\tconst descriptors={\r\n\t\tleft:getInputDescriptor('left','left','rotleft'),\r\n\t\trotleft:getInputDescriptor('pageup','rotleft', mv3d.KEYBOARD_STRAFE?'left':undefined),\r\n\t\tright:getInputDescriptor('right','right','rotright'),\r\n\t\trotright:getInputDescriptor('pagedown','rotright', mv3d.KEYBOARD_STRAFE?'right':undefined),\r\n\t}\r\n\tObject.defineProperties(Input.keyMapper,{\r\n\t\t37:descriptors.left, // left arrow\r\n\t\t39:descriptors.right,// right arrow\r\n\t\t81:descriptors.rotleft, //Q\r\n\t\t69:descriptors.rotright,//E\r\n\t\t65:descriptors.left, //A\r\n\t\t68:descriptors.right,//D\r\n\t});\r\n}\r\n\r\nfunction getInputDescriptor(menumode,p3mode,p1mode){\r\n\tlet assignedValue=undefined;\r\n\treturn {\r\n\t\tconfigurable:true,\r\n\t\tget(){\r\n\t\t\tif(assignedValue!=undefined){ return assignedValue; }\r\n\t\t\tif(!(SceneManager._scene instanceof Scene_Map)){ return menumode; }\r\n\t\t\tif(mv3d.is1stPerson()){ return p1mode; }\r\n\t\t\treturn p3mode;\r\n\t\t},\r\n\t\tset(v){ assignedValue=v; },\r\n\t};\r\n}\r\n\r\nGame_Player.prototype.getInputDirection = function() {\r\n\tlet dir = Input.dir4;\r\n\treturn mv3d.transformDirectionYaw(dir,mv3d.blendCameraYaw.currentValue(),true);\r\n};\r\n\r\nconst _player_updateMove = Game_Player.prototype.updateMove;\r\nGame_Player.prototype.updateMove = function() {\r\n\t_player_updateMove.apply(this,arguments);\r\n\tif ( !this.isMoving() && mv3d.is1stPerson() ) {\r\n\t\tmv3d.playerFaceYaw();\r\n\t}\r\n};\r\nconst _player_move_straight=Game_Player.prototype.moveStraight;\r\nGame_Player.prototype.moveStraight = function(d) {\r\n\t_player_move_straight.apply(this,arguments);\r\n\tif(!this.isMovementSucceeded()&&mv3d.is1stPerson()){\r\n\t\tmv3d.playerFaceYaw();\r\n\t}\r\n};\r\n\r\nconst raycastPredicate=mesh=>{\r\n\tif(!mesh.isEnabled() || !mesh.isVisible || !mesh.isPickable){ return false; }\r\n\tif(mesh.character){\r\n\t\tif(mesh.character.isFollower||mesh.character.isPlayer){ return false; }\r\n\t}\r\n\treturn true;\r\n}\r\n\r\nScene_Map.prototype.processMapTouch = function() {\r\n\tif (TouchInput.isTriggered() || this._touchCount > 0) {\r\n\t\tif (TouchInput.isPressed()) {\r\n\t\t\tif (this._touchCount === 0 || this._touchCount >= 15) {\r\n\t\t\t\t\r\n\t\t\t\tconst intersection = mv3d.scene.pick(TouchInput.x,TouchInput.y,raycastPredicate);\r\n\t\t\t\tif(intersection.hit){\r\n\t\t\t\t\tconst point = {x:intersection.pickedPoint.x, y:-intersection.pickedPoint.z};\r\n\t\t\t\t\tconst mesh = intersection.pickedMesh;\r\n\t\t\t\t\tif(mesh.character){\r\n\t\t\t\t\t\tpoint.x=mesh.character.x;\r\n\t\t\t\t\t\tpoint.y=mesh.character.y;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t$gameTemp.setDestination(Math.round(point.x), Math.round(point.y));\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\tthis._touchCount++;\r\n\t\t} else {\r\n\t\t\tthis._touchCount = 0;\r\n\t\t}\r\n\t}\r\n};\r\n\r\nconst _player_findDirectionTo=Game_Player.prototype.findDirectionTo;\r\nGame_Player.prototype.findDirectionTo=function(){\r\n\tconst dir = _player_findDirectionTo.apply(this,arguments);\r\n\tif(mv3d.is1stPerson() && dir){\r\n\t\tlet yaw = mv3d.dirToYaw(dir);\r\n\r\n\t\tmv3d.blendCameraYaw.setValue(yaw,0.25);\r\n\t}\r\n\treturn dir;\r\n}","import mv3d from './mv3d.js';\r\nimport { FRONTSIDE, BACKSIDE, DOUBLESIDE, Vector2 } from './mod_babylon.js';\r\nimport { makeColor, relativeNumber, booleanString } from './util.js';\r\n\r\nObject.assign(mv3d,{\r\n\ttilesetConfigurations:{},\r\n\tmapConfigurations:{},\r\n\tloadMapSettings(){\r\n\t\t//tileset\r\n\t\tthis.tilesetConfigurations={};\r\n\t\tconst lines = this.readConfigurationBlocks($gameMap.tileset().note);\r\n\t\tconst readLines = /^\\s*([abcde]\\d?\\s*,\\s*\\d+\\s*,\\s*\\d+)\\s*:(.*)$/gmi;\r\n\t\tlet match;\r\n\t\twhile(match = readLines.exec(lines)){\r\n\t\t\tconst key = match[1];\r\n\t\t\tconst conf = this.readConfigurationFunctions(match[2],this.tilesetConfigurationFunctions);\r\n\t\t\tconst tileId=this.constructTileId(...key.split(','));\r\n\t\t\tif(tileId in this.tilesetConfigurations){\r\n\t\t\t\tObject.assign(this.tilesetConfigurations[tileId],conf);\r\n\t\t\t}else{\r\n\t\t\t\tthis.tilesetConfigurations[tileId]=conf;\r\n\t\t\t}\r\n\t\t}\r\n\t\t//map\r\n\t\tconst mapconf=this.mapConfigurations={};\r\n\t\tthis.readConfigurationFunctions(\r\n\t\t\tthis.readConfigurationBlocks($dataMap.note),\r\n\t\t\tthis.mapConfigurationFunctions,\r\n\t\t\tmapconf,\r\n        );\r\n        \r\n\t\tif('fog' in mapconf){\r\n\t\t\tconst fog = mapconf.fog;\r\n\t\t\tif('color' in fog){ this.blendFogColor.setValue(fog.color,0); }\r\n\t\t\tif('near' in fog){ this.blendFogNear.setValue(fog.near,0); }\r\n\t\t\tif('far' in fog){ this.blendFogFar.setValue(fog.far,0); }\r\n\t\t}\r\n\t\tif('light' in mapconf){\r\n\t\t\tthis.blendAmbientColor.setValue(mapconf.light.color,0);\r\n\t\t\t//this.blendLightIntensity.setValue(mapconf.light.intensity,0);\r\n\t\t}\r\n\t\tif('cameraDist' in mapconf){\r\n\t\t\tthis.blendCameraDist.setValue(mapconf.cameraDist,0);\r\n\t\t}\r\n\t\tif ('cameraHeight' in mapconf){\r\n\t\t\tthis.blendCameraHeight.setValue(mapconf.cameraHeight,0);\r\n\t\t}\r\n\t\tif('cameraMode' in mapconf){\r\n\t\t\tthis.cameraMode=mapconf.cameraMode;\r\n\t\t}\r\n\t\tif('cameraPitch' in mapconf){\r\n\t\t\tthis.blendCameraPitch.setValue(mapconf.cameraPitch,0);\r\n\t\t}\r\n\t\tif('cameraYaw' in mapconf){\r\n\t\t\tthis.blendCameraYaw.setValue(mapconf.cameraYaw,0);\r\n\t\t}\r\n    },\r\n    \r\n\r\n\tgetMapConfig(key,dfault){\r\n\t\tif(key in this.mapConfigurations){\r\n\t\t\treturn this.mapConfigurations[key];\r\n\t\t}\r\n\t\treturn dfault;\r\n\t},\r\n\r\n\treadConfigurationBlocks(note){\r\n\t\tconst findBlocks = /<MV3D>([\\s\\S]*?)<\\/MV3D>/gi;\r\n\t\tlet contents = '';\r\n\t\tlet match;\r\n\t\twhile(match = findBlocks.exec(note)){\r\n\t\t\tcontents += match[1]+'\\n';\r\n\t\t}\r\n\t\treturn contents;\r\n\t},\r\n\r\n\treadConfigurationTags(note){\r\n\t\tconst findTags = /<MV3D:([\\s\\S]*?)>/gi;\r\n\t\tlet contents='';\r\n\t\tlet match;\r\n\t\twhile(match = findTags.exec(note)){\r\n\t\t\tcontents+=match[1]+'\\n';\r\n\t\t}\r\n\t\treturn contents;\r\n\t},\r\n\r\n\treadConfigurationFunctions(line,functionset=mv3d.configurationFunctions,conf={}){\r\n\t\tconst readConfigurations = /(\\w+)\\((.*?)\\)/g\r\n\t\tlet match;\r\n\t\twhile(match = readConfigurations.exec(line)){\r\n\t\t\tconst key = match[1].toLowerCase();\r\n\t\t\tif(key in functionset){\r\n\t\t\t\tfunctionset[key](conf,...match[2].split(','));\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn conf;\r\n\t},\r\n\r\n\tconfigurationSides:{\r\n\t\tfront:FRONTSIDE,\r\n\t\tback:BACKSIDE,\r\n\t\tdouble:DOUBLESIDE,\r\n\t},\r\n\tconfigurationShapes:{\r\n\t\tFLAT:1,\r\n\t\tTREE:2,\r\n\t\tSPRITE:3,\r\n\t\tFENCE:4,\r\n\t\tCROSS:5,\r\n\t\tXCROSS:6,\r\n    },\r\n    \r\n\r\n\ttilesetConfigurationFunctions:{\r\n\t\theight(conf,n){ conf.height=Number(n); },\r\n\t\tfringe(conf,n){ conf.fringe=Number(n); },\r\n\t\tfloat(conf,n){ conf.float=Number(n); },\r\n\t\ttexture(conf,img,x,y){\r\n\t\t\tconst tileId = mv3d.constructTileId(img,x,y)\r\n\t\t\tconf.sideId = conf.topId = tileId;\r\n\t\t},\r\n\t\ttop(conf,img,x,y){ conf.topId=mv3d.constructTileId(img,x,y); },\r\n\t\tside(conf,img,x,y){ conf.sideId=mv3d.constructTileId(img,x,y); },\r\n\t\tinside(conf,img,x,y){ conf.insideId=mv3d.constructTileId(img,x,y); },\r\n\t\toffset(conf,x,y){\r\n\t\t\tconf.offsetSide = conf.offsetTop = new Vector2(Number(x),Number(y));\r\n\t\t},\r\n\t\toffsettop(conf,x,y){\r\n\t\t\tconf.offsetTop = new Vector2(Number(x),Number(y));\r\n\t\t},\r\n\t\toffsetside(conf,x,y){\r\n\t\t\tconf.offsetSide = new Vector2(Number(x),Number(y));\r\n\t\t},\r\n\t\toffsetinside(conf,x,y){\r\n\t\t\tconf.offsetInside = new Vector2(Number(x),Number(y));\r\n\t\t},\r\n\t\trect(conf,img,x,y,w,h){\r\n\t\t\tthis.recttop(conf,img,x,y,w,h);\r\n\t\t\tthis.rectside(conf,img,x,y,w,h);\r\n\t\t},\r\n\t\trecttop(conf,img,x,y,w,h){\r\n\t\t\tconf.topId = mv3d.constructTileId(img,0,0);\r\n\t\t\tconf.rectTop = new PIXI.Rectangle(x,y,w,h);\r\n\t\t\tconf.rectTop.setN = mv3d.getSetNumber(conf.topId);\r\n\t\t},\r\n\t\trectside(conf,img,x,y,w,h){\r\n\t\t\tconf.sideId = mv3d.constructTileId(img,0,0);\r\n\t\t\tconf.rectSide = new PIXI.Rectangle(x,y,w,h);\r\n\t\t\tconf.rectSide.setN = mv3d.getSetNumber(conf.sideId);\r\n\t\t},\r\n\t\trectinside(conf,img,x,y,w,h){\r\n\t\t\tconf.insideId = mv3d.constructTileId(img,0,0);\r\n\t\t\tconf.rectInside = new PIXI.Rectangle(x,y,w,h);\r\n\t\t\tconf.rectInside.setN = mv3d.getSetNumber(conf.insideId);\r\n\t\t},\r\n\t\tshape(conf,name){\r\n\t\t\tconf.shape=mv3d.configurationShapes[name.toUpperCase()];\r\n\t\t},\r\n\t\talpha(conf,n){\r\n\t\t\tconf.transparent=true;\r\n\t\t\tconf.alpha=Number(n);\r\n\t\t},\r\n\t\tglow(conf,n){ conf.glow=Number(n); },\r\n\t},\r\n\teventConfigurationFunctions:{\r\n\t\theight(conf,n){\r\n\t\t\tconf.height=Number(n);\r\n\t\t},\r\n\t\tz(conf,n){ conf.z=Number(n); },\r\n\t\tx(conf,n){ conf.x=Number(n); },\r\n\t\ty(conf,n){ conf.y=Number(n); },\r\n\t\tside(conf,name){ conf.side=mv3d.configurationSides[name.toLowerCase()]; },\r\n\t\tscale(conf,x,y){ conf.scale = new Vector2(Number(x),Number(y)); },\r\n\t\trot(conf,n){ conf.rot=Number(n); },\r\n\t\tbush(conf,bool){ conf.bush = bool.toLowerCase()=='true'; },\r\n\t\tshadow(conf,bool){ conf.shadow = bool.toLowerCase()=='true'; },\r\n\t\tshadowscale(conf,n){ conf.shadowScale = Number(n); },\r\n\t\tshape(conf,name){\r\n\t\t\tconf.shape=mv3d.configurationShapes[name.toUpperCase()];\r\n\t\t},\r\n\t\tpos(conf,x,y){\r\n\t\t\tconf.pos={x:x,y:y};\r\n\t\t},\r\n\t\tlight(){ this.lamp(...arguments); },\r\n\t\tlamp(conf,color='ffffff',intensity=1,distance=mv3d.LIGHT_DIST){\r\n\t\t\tconf.lamp={color:makeColor(color).toNumber(),intensity:Number(intensity),distance:Number(distance)};\r\n\t\t},\r\n\t\tflashlight(conf,color='ffffff',intensity=1,distance=mv3d.LIGHT_DIST,angle=mv3d.LIGHT_ANGLE){\r\n\t\t\tconf.flashlight={color:makeColor(color).toNumber(),intensity:Number(intensity),distance:Number(distance),angle:Number(angle)};\r\n\t\t},\r\n\t\tflashlightpitch(conf,deg='90'){ conf.flashlightPitch=Number(deg); },\r\n\t\tflashlightyaw(conf,deg='+0'){ conf.flashlightYaw=deg; },\r\n\t\tlightheight(conf,n=1){ conf.lightHeight = Number(n); },\r\n\t\tlightoffset(conf,x=0,y=0){ conf.lightOffset = {x:+x,y:+y}; },\r\n\t\talphatest(conf,n=1){ conf.alphaTest = Number(n); }\r\n\t},\r\n\tmapConfigurationFunctions:{\r\n\t\tlight(conf,color){\r\n\t\t\tconf.light={color:makeColor(color).toNumber()};\r\n\t\t},\r\n\t\tfog(conf,color,near,far){\r\n\t\t\tif(!conf.fog){ conf.fog={}; }\r\n\t\t\tcolor=makeColor(color).toNumber(); near=Number(near); far=Number(far);\r\n\t\t\tif(!Number.isNaN(color)){ conf.fog.color=color; }\r\n\t\t\tif(!Number.isNaN(near)){ conf.fog.near=near; }\r\n\t\t\tif(!Number.isNaN(far)){ conf.fog.far=far; }\r\n\t\t},\r\n\t\tyaw(conf,n){this.camerayaw(conf,n);},\r\n\t\tpitch(conf,n){this.camerapitch(conf,n);},\r\n\t\tcamerayaw(conf,n){ conf.cameraYaw=Number(n); },\r\n\t\tcamerapitch(conf,n){ conf.cameraPitch=Number(n); },\r\n\t\tdist(conf,n){ this.cameradist(conf,n); },\r\n\t\tcameradist(conf,n){ conf.cameraDist=Number(n); },\r\n\t\theight(conf,n){ this.cameraheight(conf,n); },\r\n\t\tcameraheight(conf,n){ conf.cameraHeight=Number(n); },\r\n\t\tmode(conf,mode){ this.cameramode(conf,mode); },\r\n\t\tcameramode(conf,mode){ conf.cameraMode=mode; },\r\n\t\tedge(conf,bool){ conf.edge = booleanString(bool); },\r\n\t\tceiling(conf,img,x,y,height=mv3d.CEILING_HEIGHT){\r\n\t\t\tconf.ceiling = mv3d.constructTileId(img,x,y);\r\n\t\t\tconf.ceilingHeight = height;\r\n\t\t},\r\n\t},\r\n\r\n});\r\n\r\n// event config\r\nconst _event_setupPage = Game_Event.prototype.setupPage;\r\nGame_Event.prototype.setupPage = function() {\r\n\t_event_setupPage.apply(this,arguments);\r\n\tif(this.mv3d_sprite){\r\n\t\tthis.mv3d_needsConfigure=true;\r\n\t\tthis.mv3d_sprite.eventConfigure();\r\n\t}\r\n};\r\n\r\nconst _event_init = Game_Event.prototype.initialize;\r\nGame_Event.prototype.initialize = function() {\r\n\t_event_init.apply(this,arguments);\r\n\tif(mv3d.mapLoaded){\r\n\t\tmv3d.createCharacterFor(this);\r\n\t}\r\n\tconst event = this.event();\r\n\tlet config = {};\r\n\tmv3d.readConfigurationFunctions(\r\n\t\tmv3d.readConfigurationTags(event.note),\r\n\t\tmv3d.eventConfigurationFunctions,\r\n\t\tconfig,\r\n\t);\r\n\tif('pos' in config){\r\n\t\tthis.locate(\r\n\t\t\trelativeNumber(event.x,config.pos.x),\r\n\t\t\trelativeNumber(event.y,config.pos.y),\r\n\t\t);\r\n\t}\r\n\tif(!this.mv3d_blenders){\r\n\t\tthis.mv3d_blenders={};\r\n\t}\r\n\tif('lamp' in config){\r\n\t\tthis.mv3d_blenders.lampColor_r=config.lamp.color>>16;\r\n\t\tthis.mv3d_blenders.lampColor_g=config.lamp.color>>8&0xff;\r\n\t\tthis.mv3d_blenders.lampColor_b=config.lamp.color&0xff;\r\n\t\tthis.mv3d_blenders.lampIntensity=config.lamp.intensity;\r\n\t\tthis.mv3d_blenders.lampDistance=config.lamp.distance\r\n\t}\r\n\tif('flashlight' in config){\r\n\t\tthis.mv3d_blenders.flashlightColor_r=config.flashlight.color>>16;\r\n\t\tthis.mv3d_blenders.flashlightColor_g=config.flashlight.color>>8&0xff;\r\n\t\tthis.mv3d_blenders.flashlightColor_b=config.flashlight.color&0xff;\r\n\t\tthis.mv3d_blenders.flashlightIntensity=config.flashlight.intensity;\r\n\t\tthis.mv3d_blenders.flashlightDistance=config.flashlight.distance;\r\n\t\tthis.mv3d_blenders.flashlightAngle=config.flashlight.angle;\r\n\t}\r\n\tif('flashlightPitch' in config){\r\n\t\tthis.mv3d_blenders.flashlightPitch=Number(config.flashlightPitch);\r\n\t}\r\n\tif('flashlightYaw' in config){\r\n\t\tthis.mv3d_blenders.flashlightYaw=config.flashlightYaw;\r\n\t}\r\n\tthis.mv3d_needsConfigure=true;\r\n};","import mv3d from './mv3d.js';\r\nimport { makeColor, relativeNumber } from './util.js';\r\n\r\nconst _pluginCommand = Game_Interpreter.prototype.pluginCommand;\r\nGame_Interpreter.prototype.pluginCommand = function(command, args) {\r\n\tif(command.toLowerCase() !== 'mv3d'){\r\n\t\treturn _pluginCommand.apply(this,arguments);\r\n\t}\r\n\tconst pc = new mv3d.PluginCommand();\r\n\tpc.INTERPRETER=this;\r\n\tpc.FULL_COMMAND=[command,...args].join(' ');\r\n\targs=args.filter(v=>v);\r\n\tpc.CHAR=$gameMap.event(this._eventId);\r\n\tif(args[0]){\r\n\t\tconst firstChar = args[0][0];\r\n\t\tif(firstChar==='@'||firstChar==='＠'){\r\n\t\t\tpc.CHAR = pc.TARGET_CHAR(args.shift());\r\n\t\t}\r\n\t}\r\n\r\n\tconst com = args.shift().toLowerCase();\r\n\tif(com in pc){\r\n\t\tpc[com](...args);\r\n\t}\r\n};\r\n\r\n\r\nmv3d.PluginCommand=class{\r\n\tasync camera(...a){\r\n\t\tvar time=this._TIME(a[2]);\r\n\t\tswitch(a[0].toLowerCase()){\r\n\t\t\tcase 'pitch'    : this.pitch (a[1],time); return;\r\n\t\t\tcase 'yaw'      : this.yaw   (a[1],time); return;\r\n\t\t\tcase 'dist'     :\r\n\t\t\tcase 'distance' : this.dist  (a[1],time); return;\r\n\t\t\tcase 'height'   : this.height(a[1],time); return;\r\n\t\t\tcase 'mode'     : this.cameramode(a[1]); return;\r\n\t\t\tcase 'target': this._cameraTarget(a[1],time); return;\r\n\t\t\tcase 'pan': this.pan(a[1],a[2],a[3]); return;\r\n\t\t}\r\n\t}\r\n\tyaw(deg,time=1){\r\n\t\tthis._RELATIVE_BLEND(mv3d.blendCameraYaw,deg,time);\r\n\t\tif ( mv3d.is1stPerson() ) { mv3d.playerFaceYaw(); }\r\n\t}\r\n\tpitch(deg,time=1){ this._RELATIVE_BLEND(mv3d.blendCameraPitch,deg,time); }\r\n\tdist(n,time=1){ this._RELATIVE_BLEND(mv3d.blendCameraDist,n,time); }\r\n\theight(n,time=1){ this._RELATIVE_BLEND(mv3d.blendCameraHeight,n,time); }\r\n\t_cameraTarget(target,time){\r\n\t\tmv3d.setCameraTarget(this.TARGET_CHAR(target), time);\r\n\t}\r\n\tpan(x,y,time=1){\r\n\t\tconsole.log(x,y,time);\r\n\t\ttime=this._TIME(time);\r\n\t\tthis._RELATIVE_BLEND(mv3d.blendPanX,x,time);\r\n\t\tthis._RELATIVE_BLEND(mv3d.blendPanY,y,time);\r\n\t}\r\n\r\n\trotationmode(mode){ mv3d.rotationMode=mode; }\r\n\tpitchmode(mode){ mv3d.pitchMode=mode; }\r\n\r\n\t_VEHICLE(vehicle,data,value){\r\n\t\tdata=data.toLowerCase();\r\n\t\tconst key = `${Vehicle}_${data}`;\r\n\t\tif(data==='big'){ value=booleanString(value); }\r\n\t\telse{ value=relativeNumber(mv3d.loadData(key,0),value); }\r\n\t\tmv3d.saveData(key,value);\r\n\t}\r\n\tboat(d,v){ this._VEHICLE('boat',d,v); }\r\n\tship(d,v){ this._VEHICLE('ship',d,v); }\r\n\tairship(d,v){ this._VEHICLE('airship',d,v); }\r\n\tcameramode(mode){ mv3d.cameraMode=mode; }\r\n\tfog(...a){\r\n\t\tvar time=this._TIME(a[2]);\r\n\t\tswitch(a[0].toLowerCase()){\r\n\t\t\tcase 'color': this._fogColor(a[1],time); return;\r\n\t\t\tcase 'near': this._fogNear(a[1],time); return;\r\n\t\t\tcase 'far': this._fogFar(a[1],time); return;\r\n\t\t\tcase 'dist': case 'distance':\r\n\t\t\t\ttime=this._TIME(a[3]);\r\n\t\t\t\tthis._fogNear(a[1],time);\r\n\t\t\t\tthis._fogFar(a[2],time);\r\n\t\t\t\treturn;\r\n\t\t}\r\n\t\ttime=this._TIME(a[3]);\r\n\t\tthis._fogColor(a[0],time);\r\n\t\tthis._fogNear(a[1],time);\r\n\t\tthis._fogFar(a[2],time);\r\n\t}\r\n\t_fogColor(color,time){ mv3d.blendFogColor.setValue(makeColor(color).toNumber(),time); }\r\n\t_fogNear(n,time){ this._RELATIVE_BLEND(mv3d.blendFogNear,n,time); }\r\n\t_fogFar(n,time){ this._RELATIVE_BLEND(mv3d.blendFogFar,n,time); }\r\n\tlight(...a){\r\n\t\tvar time=this._TIME(a[2]);\r\n\t\tswitch(a[0].toLowerCase()){\r\n\t\t\tcase 'color'    : this._lightColor    (a[1],time); return;\r\n\t\t\t//case 'intensity': this._lightIntensity(a[1],time); return;\r\n\t\t}\r\n\t\ttime=this._TIME(a[1]);\r\n\t\tthis._lightcolor(a[0],time);\r\n\t\t//this._lightintensity(a[0],time);\r\n\t}\r\n\t_lightColor(color,time=1){ mv3d.blendAmbientColor.setValue(makeColor(color).toNumber(),time); }\r\n\t//_lightIntensity(n,time=1){ this._RELATIVE_BLEND(mv3d.blendLightIntensity,n,time); }\r\n\tasync lamp(...a){\r\n\t\tconst char = await this.AWAIT_CHAR(this.CHAR);\r\n\t\tchar.setupLamp();\r\n\t\tvar time=this._TIME(a[2]);\r\n\t\tswitch(a[0].toLowerCase()){\r\n\t\t\tcase 'color'    : this._lampColor    (char,a[1],time); return;\r\n\t\t\tcase 'intensity': this._lampIntensity(char,a[1],time); return;\r\n\t\t\tcase 'dist'     :\r\n\t\t\tcase 'distance' : this._lampDistance (char,a[1],time); return;\r\n\t\t}\r\n\t\ttime=this._TIME(a[3]);\r\n\t\tthis._lampColor(char,a[0],time);\r\n\t\tthis._lampIntensity(char,a[1],time);\r\n\t\tthis._lampDistance(char,a[2],time);\r\n\t}\r\n\t_lampColor(char,color,time=1){ char.blendLampColor.setValue(makeColor(color).toNumber(),time); }\r\n\t_lampIntensity(char,n,time=1){ this._RELATIVE_BLEND(char.blendLampIntensity,n,time); }\r\n\t_lampDistance(char,n,time=1){ this._RELATIVE_BLEND(char.blendLampDistance,n,time); }\r\n\tasync flashlight(...a){\r\n\t\tconst char = await this.AWAIT_CHAR(this.CHAR);\r\n\t\tchar.setupFlashlight();\r\n\t\tvar time=this._TIME(a[2]);\r\n\t\tswitch(a[0].toLowerCase()){\r\n\t\t\tcase 'color'    : this._flashlightColor    (char,a[1],time); return;\r\n\t\t\tcase 'intensity': this._flashlightIntensity(char,a[1],time); return;\r\n\t\t\tcase 'dist'     :\r\n\t\t\tcase 'distance' : this._flashlightDistance (char,a[1],time); return;\r\n\t\t\tcase 'angle'    : this._flashlightAngle    (char,a[1],time); return;\r\n\t\t\tcase 'yaw'      : this._flashlightYaw      (char,a[1],time); return;\r\n\t\t\tcase 'pitch'    : this._flashlightPitch    (char,a[1],time); return;\r\n\t\t}\r\n\t\ttime=this._TIME(a[4]);\r\n\t\tthis._flashlightColor(char,a[0],time);\r\n\t\tthis._flashlightIntensity(char,a[1],time);\r\n\t\tthis._flashlightDistance(char,a[2],time);\r\n\t\tthis._flashlightAngle(char,a[3],time);\r\n\t}\r\n\t_flashlightColor(char,color,time){ char.blendFlashlightColor.setValue(makeColor(color).toNumber(),time); }\r\n\t_flashlightIntensity(char,n,time){ this._RELATIVE_BLEND(char.blendFlashlightIntensity,n,time); }\r\n\t_flashlightDistance(char,n,time){ this._RELATIVE_BLEND(char.blendFlashlightDistance,n,time); }\r\n\t_flashlightAngle(char,n,time){ this._RELATIVE_BLEND(char.blendFlashlightAngle,n,time); }\r\n\t_flashlightPitch(char,n,time){ this._RELATIVE_BLEND(char.blendFlashlightPitch,n,time); }\r\n\t_flashlightYaw(char,yaw,time){ char.flashlightTargetYaw=yaw; }\r\n\t_RELATIVE_BLEND(blender,n,time){ blender.setValue(relativeNumber(blender.targetValue(),n),Number(time)); }\r\n\t_TIME(time){\r\n\t\tif(typeof time==='number'){ return time; }\r\n\t\ttime=Number(time);\r\n\t\tif(Number.isNaN(time)){ return 1; }\r\n\t\treturn time;\r\n\t}\r\n\tERROR_CHAR(){\r\n\t\tconsole.warn(`MV3D: Plugin command \\`${this.FULL_COMMAND}\\` failed because target character was invalid.`);\r\n\t\t//console.log(this.CHAR);\r\n\t}\r\n\tasync AWAIT_CHAR(char){\r\n\t\tif(!char){ return this.ERROR_CHAR(); }\r\n\t\tlet w=0;\r\n\t\twhile(!char.mv3d_sprite){\r\n\t\t\tawait sleep(100);\r\n\t\t\tif(++w>10){ return this.ERROR_CHAR(); }\r\n\t\t}\r\n\t\treturn char.mv3d_sprite;\r\n\t}\r\n\tTARGET_CHAR(target){\r\n\t\treturn mv3d.targetChar(target,$gameMap.event(this.INTERPRETER._eventId),this.CHAR);\r\n\t}\r\n};\r\n\r\nmv3d.targetChar=function(target,self=null,dfault=null){\r\n\tif(!target){ return dfault; }\r\n\tlet m=target.toLowerCase().match(/[a-z]+/);\r\n\tconst mode=m?m[0]:'e';\r\n\tm=target.match(/\\d+/);\r\n\tconst id=m?Number(m[0]):0;\r\n\tswitch(mode[0]){\r\n\t\tcase 's': return self;\r\n\t\tcase 'p': return $gamePlayer;\r\n\t\tcase 'e':\r\n\t\t\tif(!id){ return self; }\r\n\t\t\treturn $gameMap.event(id);\r\n\t\tcase 'v':\r\n\t\t\treturn $gameMap.vehicle(id);\r\n\t\tcase 'f':\r\n\t\t\treturn $gamePlayer.followers()._data[id];\r\n\t}\r\n\treturn char;\r\n}\r\nmv3d.getTargetString=function(char){\r\n\tif( char instanceof Game_Player){\r\n\t\treturn `@p`;\r\n\t}\r\n\tif( char instanceof Game_Event ){\r\n\t\treturn `@e${char._eventId}`;\r\n\t}\r\n\tif( char instanceof Game_Follower){\r\n\t\treturn `@f${$gamePlayer._followers._data.indexOf(char)}`;\r\n\t}\r\n\tif( char instanceof Game_Vehicle){\r\n\t\treturn `@v${$gameMap._vehicles.indexOf(char)}`;\r\n\t}\r\n}","import mv3d from './mv3d.js';\r\nimport { v2origin, tileSize } from './util.js';\r\n\r\nObject.assign(mv3d,{\r\n\r\n\t_tilemap:null,\r\n\tgetTilemap(){\r\n\t\tif(SceneManager._scene&&SceneManager._scene._spriteset){\r\n\t\t\tthis._tilemap = SceneManager._scene._spriteset._tilemap;\r\n\t\t}\r\n\t\treturn this._tilemap;\r\n\t},\r\n\r\n\tgetSetNumber(id){\r\n\t\tif(Tilemap.isAutotile(id)){\r\n\t\t\treturn Tilemap.isTileA1(id)?0\r\n\t\t\t\t: Tilemap.isTileA2(id)?1 : Tilemap.isTileA3(id)?2 : 3;\r\n\t\t}else{\r\n\t\t\treturn Tilemap.isTileA5(id)?4:5+Math.floor(id/256);\r\n\t\t}\r\n\t},\r\n\r\n\tgetTerrainTag(tileId){\r\n\t\treturn $gameMap.tilesetFlags()[tileId]>>12;\r\n\t},\r\n\r\n\tgetMaterialOptions(tileId){\r\n\t\tconst options={};\r\n\t\t/*\r\n\t\tconst ttag = this.getTerrainTag(tileId);\r\n\t\tif(ttag && ttag in this.TTAG_DATA){\r\n\t\t\tconst tagdata = this.TTAG_DATA[ttag];\r\n\t\t}\r\n\t\t*/\r\n\t\tconst conf = this.tilesetConfigurations[this.normalizeAutotileId(tileId)];\r\n\t\tif(conf){\r\n\t\t\tif ('alpha' in conf){ options.alpha=conf.alpha; }\r\n\t\t\tif ('transparent' in conf){ options.transparent=conf.transparent; }\r\n\t\t\tif ('glow' in conf){ options.glow=conf.glow; }\r\n\t\t}\r\n\t\treturn options;\r\n\t},\r\n\r\n\tgetTileConfig(tileId){\r\n\t\t//offsets can come either from terrain tag or tileset notes\r\n\t\tlet offsetTop = v2origin;\r\n\t\tlet offsetSide = v2origin;\r\n\t\tlet offsetInside = null;\r\n\t\tlet offsetBottom = null;\r\n\t\tconst tilemap=this.getTilemap();\r\n\t\tconst ret = {\r\n\t\t\ttopId:null,\r\n\t\t\tsideId:null,\r\n\t\t\tinsideId:null,\r\n\t\t\tbottomId:null,\r\n\t\t\tfringe:tilemap&&tilemap._isHigherTile(tileId)?this.FRINGE_HEIGHT:0,\r\n\t\t\tfringeHeight:0,\r\n\t\t}\r\n\t\tconst ttag = this.getTerrainTag(tileId);\r\n\t\tif(ttag && ttag in this.TTAG_DATA){\r\n\t\t\tconst tagdata = this.TTAG_DATA[ttag];\r\n\t\t\toffsetTop = tagdata.offsetTop;\r\n\t\t\toffsetSide = tagdata.offsetSide;\r\n\t\t\tret.height=tagdata.height; \r\n\t\t\tret.fringeHeight=tagdata.height;\r\n\t\t\tret.shape=tagdata.shape;\r\n\t\t}\r\n\t\tconst conf = this.tilesetConfigurations[this.normalizeAutotileId(tileId)];\r\n\t\tif(conf){\r\n\t\t\tif(conf.offsetTop){ offsetTop=conf.offsetTop; }\r\n\t\t\tif(conf.offsetSide){ offsetSide=conf.offsetSide; }\r\n\t\t\tif(conf.offsetInside){ offsetInside=conf.offsetInside; }\r\n\t\t\tif(conf.offsetBottom){ offsetBottom=conf.offsetBottom; }\r\n\t\t\tif('topId' in conf){ ret.topId=conf.topId; }\r\n\t\t\tif('sideId' in conf){ ret.sideId=conf.sideId; }\r\n\t\t\tif('insideId' in conf){ ret.insideId=conf.insideId; }\r\n\t\t\tif('bottomId' in conf){ ret.bottomId=conf.bottomId; }\r\n\t\t\tif(conf.rectTop){ ret.rectTop=conf.rectTop; }\r\n\t\t\tif(conf.rectSide){ ret.rectSide=conf.rectSide; }\r\n\t\t\tif(conf.rectInside){ ret.rectInside=conf.rectInside; }\r\n\t\t\tif(conf.rectBottom){ ret.rectBottom=conf.rectBottom; }\r\n\t\t\tif('shape' in conf){ ret.shape=conf.shape; }\r\n\t\t\tif('fringe' in conf){ ret.fringe=conf.fringe; }\r\n\t\t\tif('height' in conf){\r\n\t\t\t\tret.height=conf.height;\r\n\t\t\t\tret.fringeHeight = conf.height;\r\n\t\t\t}\r\n\r\n\t\t\tret.hasInsideConf=Boolean(conf.offsetInside||conf.rectInside||('insideId' in conf));\r\n\t\t\tret.hasBottomConf=Boolean(conf.offsetBottom||conf.rectBottom||('bottomId' in conf));\r\n\t\t}\r\n\t\tconst tileRange = Tilemap.isAutotile(tileId)?48:1;\r\n\t\tif(ret.topId==null){ ret.topId = tileId+offsetTop.x*tileRange+offsetTop.y*tileRange*8; }\r\n\t\tif(ret.sideId==null){ ret.sideId = tileId+offsetSide.x*tileRange+offsetSide.y*tileRange*8; }\r\n\t\tif(ret.insideId==null){ \r\n\t\t\tret.insideId=ret.sideId;\r\n\t\t\tif(offsetInside){\r\n\t\t\t\tret.insideId=tileId+offsetInside.x*tileRange+offsetInside.y*tileRange*8;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(ret.bottomId==null){\r\n\t\t\tret.bottomId=ret.topId;\r\n\t\t\tif(offsetBottom){\r\n\t\t\t\tret.bottomId=tileId+offsetBottom.x*tileRange+offsetBottom.y*tileRange*8;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn ret;\r\n\t},\r\n\r\n\tgetTileData(x,y){\r\n\t\tif(!$dataMap || !$dataMap.data){ return [0,0,0,0]; }\r\n\t\tconst data = $dataMap.data;\r\n\t\tconst width = $dataMap.width;\r\n\t\tconst height = $dataMap.height;\r\n\t\tif($gameMap.isLoopHorizontal()){\r\n\t\t\tx=x.mod(width);\r\n\t\t}\r\n\t\tif($gameMap.isLoopVertical()){\r\n\t\t\ty=y.mod(height);\r\n\t\t}\r\n\t\tif(x<0||x>=width||y<0||y>=height){ return [0,0,0,0]; }\r\n\t\tconst tileData=[];\r\n\t\tfor (let z=0;z<4;++z){//4 tile layers. Ignore shadow bits.\r\n\t\t\ttileData[z] = data[(z * height + y) * width + x] || 0;\r\n\t\t}\r\n\t\treturn tileData;\r\n\t},\r\n\r\n\r\n\tgetTileHeight(x,y,l=0){\r\n\t\tif(!$dataMap){ return 0; }\r\n\r\n\t\tif($gameMap.isLoopHorizontal()){ x=x.mod($dataMap.width); }\r\n\t\tif($gameMap.isLoopVertical()){ y=y.mod($dataMap.height); }\r\n\r\n\t\tconst tileId=this.getTileData(x,y)[l];\r\n\t\tif(this.isTileEmpty(tileId)){ return 0; }\r\n\t\t// finge tiles don't stack normally. fringeHeight property should be used when drawing them.\r\n\t\tconst tilemap=this.getTilemap();\r\n\t\tif(tilemap&&tilemap._isHigherTile(tileId)){ return 0; }\r\n\r\n\t\tlet defaultHeight = 0;\r\n\r\n\t\tconst conf = this.tilesetConfigurations[this.normalizeAutotileId(tileId)];\r\n\t\tconst region = $gameMap.regionId(x,y);\r\n\t\tif(l===0 && region && region in mv3d.REGION_DATA){\r\n\t\t\tlet height = this.REGION_DATA[region].height;\r\n\t\t\tif(conf&&'height' in conf&&conf.height<0){\r\n\t\t\t\theight+=conf.height;\r\n\t\t\t}\r\n\t\t\treturn height;\r\n\t\t}\r\n\t\tif(conf){\r\n\t\t\tif('height' in conf){\r\n\t\t\t\treturn conf.height;\r\n\t\t\t}\r\n\t\t\tif(this.isSpecialShape(conf.shape)){\r\n\t\t\t\tdefaultHeight=1;\r\n\t\t\t}\r\n\t\t}\r\n\t\tconst ttag=this.getTerrainTag(tileId);\r\n\t\tif(ttag && ttag in this.TTAG_DATA){\r\n\t\t\treturn this.TTAG_DATA[ttag].height;\r\n\t\t}\r\n\t\tif(this.isWallTile(tileId)){\r\n\t\t\treturn this.WALL_HEIGHT;\r\n\t\t}\r\n\t\tif(tilemap&&tilemap._isTableTile(tileId)){\r\n\t\t\treturn this.TABLE_HEIGHT;\r\n\t\t}\r\n\t\treturn defaultHeight;\r\n\t},\r\n\r\n\tgetStackHeight(x,y,layerId=3){\r\n\t\tlet height=0;\r\n\t\tfor(let l=0; l<=layerId; ++l){\r\n\t\t\theight+=this.getTileHeight(x,y,l);\r\n\t\t}\r\n\t\treturn height;\r\n\t},\r\n\r\n\tgetWalkHeight(x,y){\r\n\t\t// get the height of characters for given x,y coord. Uses float coords. Should support ramps.\r\n\t\tconst tileData=this.getTileData(Math.round(x),Math.round(y));\r\n\t\tlet height=0;\r\n\t\tlet tileHeight=0;\r\n\t\tfor(let l=0; l<=3; ++l){\r\n\t\t\tconst tileId=tileData[l];\r\n\t\t\tif(this.isTileEmpty(tileId)){ continue; }\r\n\t\t\theight += tileHeight;\r\n\t\t\ttileHeight = this.getTileHeight(Math.round(x),Math.round(y),l);\r\n\t\t\tconst data = this.getTileConfig(tileId);\r\n\t\t\tconst shape = data.shape;\r\n\t\t\tif(!this.isSpecialShape(shape)){\r\n\t\t\t\theight+=tileHeight;\r\n\t\t\t\ttileHeight=0;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn height;\r\n\t\t\r\n\t},\r\n\r\n\tgetFloatHeight(x,y){\r\n\t\tconst tileData=this.getTileData(x,y);\r\n\t\tlet float=0;\r\n\t\tfor(let l=0; l<=3; ++l){\r\n\t\t\tconst tileId=tileData[l];\r\n\t\t\tif(this.isTileEmpty(tileId)){ continue; }\r\n\t\t\tconst conf = this.tilesetConfigurations[this.normalizeAutotileId(tileId)];\r\n\t\t\tif(conf && 'float' in conf){\r\n\t\t\t\tfloat += conf.float;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn float;\r\n\t},\r\n\r\n\tgetFringeHeight(x,y,layerId=3){\r\n\t\tlet height = this.getStackHeight(x,y,layerId-1);\r\n\t\tconst tileId=this.getTileData(x,y)[layerId];\r\n\t\tconst conf = this.tilesetConfigurations[this.normalizeAutotileId(tileId)];\r\n\t\tif(conf && this.getTilemap()._isHigherTile(tileId)){\r\n\t\t\treturn height + (conf.fringe||this.FRINGE_HEIGHT) + (conf.height||0);\r\n\t\t}\r\n\t\treturn 0;\r\n\t},\r\n\r\n\tgetCullingHeight(x,y,layerId=3,ignorePits=false){\r\n\t\tconst tileData=this.getTileData(x,y);\r\n\t\tlet height=0;\r\n\t\tfor(let l=0; l<=layerId; ++l){\r\n\t\t\tconst tileId=tileData[l];\r\n\t\t\tconst data = this.getTileConfig(tileId);\r\n\t\t\tconst shape = data.shape;\r\n\t\t\tif(this.isSpecialShape(shape)){\r\n\t\t\t\treturn height;\r\n\t\t\t}\r\n\t\t\tif(ignorePits&&data.height<0){\r\n\t\t\t\theight-=data.height;\r\n\t\t\t}\r\n\t\t\theight+=this.getTileHeight(x,y,l);\r\n\t\t}\r\n\t\treturn height;\r\n\t},\r\n\r\n\tgetTileRects(tileId){\r\n\t\tconst rects = [];\r\n\t\tconst tilemap=this.getTilemap();\r\n\t\tconst isTable=tilemap._isTableTile(tileId);\r\n\t\ttilemap._drawTile({addRect:(sheetId,sx,sy,dx,dy,width,height,animX,animY)=>{\r\n\t\t\trects.push({setN:sheetId,x:sx,y:sy,width:width,height:height,ox:dx,oy:dy});\r\n\t\t}}, tileId, 0,0);\r\n\t\tif (isTable) for (let i=rects.length-1;i>=0;--i){\r\n\t\t\tif(rects[i].oy>tileSize()/2){\r\n\t\t\t\trects[i-1].y+=tileSize()*2/3;\r\n\t\t\t\trects.splice(i,1);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn rects;\r\n\t},\r\n\r\n\tisTileEmpty(tileId){\r\n\t\treturn !tileId||tileId===1544;\r\n\t},\r\n\r\n\tisWallTile(tileId){\r\n\t\tconst kind = Tilemap.getAutotileKind(tileId);\r\n\t\tconst ty = Math.floor(kind / 8);\r\n\t\tconst isWall = Tilemap.isTileA3(tileId) || Tilemap.isTileA4(tileId);\r\n\t\tif (isWall && ty%2){ return 2; }\r\n\t\treturn isWall;\r\n\t},\r\n\r\n\tisTableTile(tileId){\r\n\t\treturn Boolean(this.getTilemap()._isTableTile(tileId));\r\n\t},\r\n\r\n\tisFringeTile(tileId){\r\n\t\treturn Boolean(this.getTilemap()._isHigherTile(tileId));\r\n\t},\r\n\r\n\tisWaterfallTile(tileId){\r\n\t\tconst kind = Tilemap.getAutotileKind(tileId);\r\n\t\treturn Tilemap.isTileA1(tileId)&&kind>=4&&kind%2;\r\n\t},\r\n\r\n\tisSpecialShape(shape){\r\n\t\tconst shapes = mv3d.configurationShapes;\r\n\t\treturn shape===shapes.FENCE||shape===shapes.CROSS||shape===shapes.XCROSS;\r\n\t},\r\n\r\n\tconstructTileId(img,x,y){\r\n\t\tconst key = `TILE_ID_${img.toUpperCase()}`\r\n\t\tlet tileId = key in Tilemap ? Tilemap[key] : 0;\r\n\t\tconst tileRange = Tilemap.isAutotile(tileId) ? 48 : 1;\r\n\t\ttileId += Number(x)*tileRange + Number(y)*tileRange*8;\r\n\t\treturn tileId;\r\n\t},\r\n\tnormalizeAutotileId(tileId){\r\n\t\tif(!Tilemap.isAutotile(tileId)){ return tileId; }\r\n\t\tconst kind = Tilemap.getAutotileKind(tileId);\r\n\t\treturn Tilemap.TILE_ID_A1 + kind*48;\r\n\t},\r\n\r\n});","import mv3d from './mv3d.js';\r\nimport { TransformNode, Mesh, MeshBuilder, Vector3, Vector2, FRONTSIDE, BACKSIDE, WORLDSPACE, LOCALSPACE, DOUBLESIDE, Plane } from \"./mod_babylon.js\";\r\nimport { tileSize, XAxis, YAxis, tileWidth, tileHeight } from './util.js';\r\n\r\nconst SOURCEPLANE_GROUND = new Plane(0, 1, -Math.pow(0.1,100), 0);\r\nconst SOURCEPLANE_WALL = new Plane(0,0,-1,0);\r\n\r\nexport class MapCell extends TransformNode{\r\n\tconstructor(cx,cy){\r\n\t\tconst key = [cx,cy].toString();\r\n\t\tsuper(`MapCell[${key}]`,mv3d.scene);\r\n\t\tthis.parent=mv3d.map;\r\n\t\t//mv3d.cells[key]=this;\r\n\t\tthis.cx=cx; this.cy=cy;\r\n\t\tthis.ox=cx*mv3d.CELL_SIZE; this.oy=cy*mv3d.CELL_SIZE;\r\n\t\tthis.x=this.ox; this.y=this.oy;\r\n\t\tthis.key=key;\r\n\r\n\t\tthis.load();\r\n\t}\r\n\tupdate(){\r\n\t\tconst loopPos = mv3d.loopCoords((this.cx+0.5)*mv3d.CELL_SIZE,(this.cy+0.5)*mv3d.CELL_SIZE);\r\n\t\tthis.x=loopPos.x-mv3d.CELL_SIZE/2;\r\n\t\tthis.y=loopPos.y-mv3d.CELL_SIZE/2;\r\n\t}\r\n\tcreateMesh(width=1,height=1,side=FRONTSIDE, isWall){\r\n\t\tconst mesh = MeshBuilder.CreatePlane('tile',{\r\n\t\t\tsideOrientation: side,\r\n\t\t\twidth:width, height:height,\r\n\t\t\t//subdivisions:1,\r\n\t\t\tsourcePlane: isWall ? SOURCEPLANE_WALL : SOURCEPLANE_GROUND,\r\n\t\t},mv3d.scene);\r\n\t\tthis.submeshes.push(mesh);\r\n\t\treturn mesh;\r\n\t}\r\n\tload(){\r\n\t\tconst shapes = mv3d.configurationShapes;\r\n\t\tthis.submeshes=[];\r\n\t\t// load all tiles in mesh\r\n\t\tconst cellWidth = Math.min(mv3d.CELL_SIZE,$gameMap.width()-this.cx*mv3d.CELL_SIZE);\r\n\t\tconst cellHeight = Math.min(mv3d.CELL_SIZE,$gameMap.height()-this.cy*mv3d.CELL_SIZE);\r\n\t\tfor (let y=0; y<cellHeight; ++y)\r\n\t\tfor (let x=0; x<cellWidth; ++x){\r\n\t\t\tlet nlnowall = 0; // the number of layers in a row that haven't had walls.\r\n\t\t\tconst tileData = mv3d.getTileData(this.ox+x,this.oy+y);\r\n\t\t\tfor (let l=0; l<4; ++l){\r\n\t\t\t\tlet z = mv3d.getStackHeight(this.ox+x,this.oy+y,l);\r\n\t\t\t\tconst tileConf = mv3d.getTileConfig(tileData[l]);\r\n\t\t\t\tconst shape = tileConf.shape;\r\n\t\t\t\ttileConf.realId = tileData[l];\r\n\t\t\t\t//tileConf.isAutotile = Tilemap.isAutotile(tileData[l]);\r\n\t\t\t\t//tileConf.isFringe = mv3d.isFringeTile(tileData[l]);\r\n\t\t\t\t//tileConf.isTable = mv3d.isTableTile(tileData[l]);\r\n\t\t\t\tconst wallHeight = mv3d.getTileHeight(this.ox+x,this.oy+y,l)||tileConf.height||0;\r\n\t\t\t\tz+=tileConf.fringe;\r\n\t\t\t\tif(mv3d.isFringeTile(tileData[l])){ z+=tileConf.fringeHeight; }\r\n\t\t\t\tif(!shape||shape===shapes.FLAT){\r\n\t\t\t\t\tthis.loadTile(tileConf,x,y,z,l);\r\n\t\t\t\t\t//decide if we need to draw bottom of tile\r\n\t\t\t\t\tif(tileConf.hasBottomConf||tileConf.height>0&&(l>0||tileConf.fringe>0)){\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//decide whether to draw walls\r\n\t\t\t\t\tif(wallHeight){\r\n\t\t\t\t\t\tthis.loadWalls(tileConf,x,y,z,l,wallHeight + nlnowall*mv3d.LAYER_DIST);\r\n\t\t\t\t\t\tnlnowall=0;\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\t++nlnowall;\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{ nlnowall=0; }\r\n\t\t\t\tif(shape===shapes.FENCE){\r\n\t\t\t\t\tthis.loadFence(tileConf,x,y,z,l,wallHeight);\r\n\t\t\t\t}else if(shape===shapes.CROSS||shape===shapes.XCROSS){\r\n\t\t\t\t\tthis.loadCross(tileConf,x,y,z,l,wallHeight);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t// merge meshes\r\n\t\tif(this.submeshes.length){\r\n\t\t\tthis.mesh=Mesh.MergeMeshes(this.submeshes,true,undefined,undefined,false,true);\r\n\t\t}else{\r\n\t\t\tconsole.warn(\"MV3D: Created empty map cell!\");\r\n\t\t\tthis.mesh = new Mesh(\"empty mesh\",mv3d.scene);\r\n\t\t}\r\n\t\tthis.mesh.parent=this;\r\n\t\tdelete this.submeshes;\r\n\t}\r\n\tloadTile(tileConf,x,y,z,l,ceiling=false){\r\n\t\tconst tileId = ceiling?tileConf.bottomId:tileConf.topId;\r\n\t\tconst configRect = ceiling?tileConf.rectTop:tileConf.rectBottom;\r\n\t\tconst isAutotile = Tilemap.isAutotile(tileId);\r\n\t\tconst setN = mv3d.getSetNumber(tileId);\r\n\t\tlet rects;\r\n\t\tif(configRect){\r\n\t\t\trects=[configRect];\r\n\t\t}else{\r\n\t\t\trects = mv3d.getTileRects(tileId);\r\n\t\t}\r\n\t\tfor (const rect of rects){\r\n\t\t\tconst mesh = this.createMesh(1-isAutotile/2,1-isAutotile/2,ceiling?BACKSIDE:FRONTSIDE);\r\n\t\t\tmesh.material = mv3d.getCachedTileMaterial(setN,rect.x,rect.y,rect.width,rect.height, mv3d.getMaterialOptions(tileId));\r\n\t\t\tmesh.x = x + (rect.ox|0)/tileSize() - 0.25*isAutotile;\r\n\t\t\tmesh.y = y + (rect.oy|0)/tileSize() - 0.25*isAutotile;\r\n\t\t\tmesh.z = z + l*mv3d.LAYER_DIST;\r\n\t\t}\r\n\t}\r\n\tloadWalls(tileConf,x,y,z,l,wallHeight){\r\n\t\tconst realWallHeight = wallHeight;\r\n\t\tconst isFringe = mv3d.isFringeTile(tileConf.realId);\r\n\t\tfor (let ni=0; ni<MapCell.neighborPositions.length; ++ni){\r\n\t\t\tconst np = MapCell.neighborPositions[ni];\r\n\t\t\t// don't render walls on edge of map (unless it loops)\r\n\t\t\tif( !mv3d.getMapConfig('edge',true) )\r\n\t\t\tif((this.ox+x+np.x>=$dataMap.width||this.ox+x+np.x<0)&&!$gameMap.isLoopHorizontal()\r\n\t\t\t||(this.oy+y+np.y>=$dataMap.height||this.oy+y+np.y<0)&&!$gameMap.isLoopVertical()){\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tif(tileConf.height<0 && z<mv3d.getStackHeight(this.ox+x+np.x,this.oy+y+np.y,l)){\r\n\t\t\t\twallHeight=tileConf.height;\r\n\t\t\t}else{\r\n\t\t\t\twallHeight=realWallHeight;\r\n\t\t\t}\r\n\t\t\tlet tileId=tileConf.sideId;\r\n\t\t\tlet configRect;\r\n\t\t\tif(wallHeight<0 && tileConf.hasInsideConf){\r\n\t\t\t\ttileId=tileConf.insideId;\r\n\t\t\t\tif(tileConf.rectInside){ configRect = tileConf.rectInside; }\r\n\t\t\t}else{\r\n\t\t\t\tif(tileConf.rectSide){ configRect = tileConf.rectSide; }\r\n\t\t\t}\r\n\t\t\tconst setN = mv3d.getSetNumber(tileId);\r\n\r\n\t\t\tlet neededHeight=wallHeight;\r\n\t\t\tif(isFringe){\r\n\t\t\t\tconst neighborHeight = mv3d.getFringeHeight(this.ox+x+np.x,this.oy+y+np.y,l);\r\n\t\t\t\tif(neighborHeight===z){ continue; }\r\n\t\t\t}else{\r\n\t\t\t\tconst neighborHeight = mv3d.getCullingHeight(this.ox+x+np.x,this.oy+y+np.y,l,!(tileConf.height<0));\r\n\t\t\t\tif(wallHeight>0&&neighborHeight>=z\r\n\t\t\t\t||wallHeight<0&&neighborHeight<=z){ continue; }\r\n\t\t\t\tneededHeight = Math.min(Math.abs(wallHeight), Math.abs(z-neighborHeight))*Math.sign(wallHeight);\r\n\t\t\t}\r\n\t\t\tconst wallPos = new Vector3( x+np.x/2, y+np.y/2, z );\r\n\t\t\tconst rot = Math.atan2(np.x, np.y);\r\n\t\t\tif(configRect || !Tilemap.isAutotile(tileId)){\r\n\t\t\t\tconst rect = configRect ? configRect : mv3d.getTileRects(tileId)[0];\r\n\t\t\t\tconst mesh = this.createMesh(1,neededHeight,FRONTSIDE,true);\r\n\t\t\t\tif(neededHeight<0){ mesh.scaling.y*=-1; }\r\n\t\t\t\tmesh.material = mv3d.getCachedTileMaterial(setN,rect.x,rect.y,rect.width,rect.height, mv3d.getMaterialOptions(tileId));\r\n\t\t\t\t//mesh.rotate(XAxis,-Math.PI/2,WORLDSPACE);\r\n\t\t\t\tmesh.rotate(YAxis,-rot,WORLDSPACE);\r\n\t\t\t\tmesh.x=wallPos.x;\r\n\t\t\t\tmesh.y=wallPos.y;\r\n\t\t\t\tmesh.z= z - neededHeight/2;\r\n\t\t\t}else{ // Autotile\r\n\t\t\t\tconst npl=MapCell.neighborPositions[(+ni-1).mod(4)];\r\n\t\t\t\tconst npr=MapCell.neighborPositions[(+ni+1).mod(4)];\r\n\t\t\t\tconst leftHeight = mv3d.getStackHeight(this.ox+x+npl.x,this.oy+y+npl.y,l);\r\n\t\t\t\tconst rightHeight = mv3d.getStackHeight(this.ox+x+npr.x,this.oy+y+npr.y,l);\r\n\t\t\t\tconst {x:bx,y:by} = this.getAutotileCorner(tileId,tileConf.realId);\r\n\t\t\t\tlet wallParts=Math.abs(Math.round(neededHeight*2));\r\n\t\t\t\tlet partHeight=Math.abs(neededHeight/wallParts);\r\n\t\t\t\tlet sw = tileSize()/2;\r\n\t\t\t\tlet sh = tileSize()/2;\r\n\t\t\t\tif(mv3d.isTableTile(tileConf.realId)){\r\n\t\t\t\t\tsh=tileSize()/3;\r\n\t\t\t\t\twallParts=1;\r\n\t\t\t\t\tpartHeight=wallHeight;\r\n\t\t\t\t\t//partHeight=neededHeight;\r\n\t\t\t\t}\r\n\t\t\t\tfor (let ax=-1; ax<=1; ax+=2){\r\n\t\t\t\t\tfor(let az=0;az<wallParts;++az){\r\n\t\t\t\t\t\tlet hasLeftEdge,hasRightEdge;\r\n\t\t\t\t\t\tif(mv3d.isTableTile(tileConf.realId)){\r\n\t\t\t\t\t\t\thasLeftEdge = leftHeight!=z;\r\n\t\t\t\t\t\t\thasRightEdge = rightHeight!=z;\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\thasLeftEdge = leftHeight<z-az*partHeight;\r\n\t\t\t\t\t\t\thasRightEdge = rightHeight<z-az*partHeight;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tlet sx,sy;\r\n\t\t\t\t\t\tsx=bx*tileSize();\r\n\t\t\t\t\t\tsy=by*tileSize();\r\n\t\t\t\t\t\tsx=(bx+(ax>0?0.5+hasRightEdge:1-hasLeftEdge))*tileSize();\r\n\t\t\t\t\t\tif(neededHeight<0){\r\n\t\t\t\t\t\t\tsx=(bx+(ax>0?0+hasLeftEdge:1.5-hasRightEdge))*tileSize();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif(mv3d.isWaterfallTile(tileId)){\r\n\t\t\t\t\t\t\tsy=(by+az%2/2)*tileSize();\r\n\t\t\t\t\t\t}else if(mv3d.isTableTile(tileId)){\r\n\t\t\t\t\t\t\tsy=(by+5/3)*tileSize();\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tsy=(by+(az===0?0:az===wallParts-1?1.5:1-az%2*0.5))*tileSize();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tconst mesh = this.createMesh(0.5,partHeight,FRONTSIDE,true);\r\n\t\t\t\t\t\t//mesh.rotate(XAxis,-Math.PI/2,WORLDSPACE);\r\n\t\t\t\t\t\tmesh.rotate(YAxis,-rot,WORLDSPACE);\r\n\t\t\t\t\t\tmesh.x=wallPos.x;\r\n\t\t\t\t\t\tmesh.y=wallPos.y;\r\n\t\t\t\t\t\tmesh.z= z - partHeight/2 - partHeight*az + l*mv3d.LAYER_DIST;\r\n\t\t\t\t\t\tmesh.translate(XAxis,0.25*ax,LOCALSPACE);\r\n\t\t\t\t\t\tmesh.material = mv3d.getCachedTileMaterial(setN,sx,sy,sw,sh, mv3d.getMaterialOptions(tileId));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tloadFence(tileConf,x,y,z,l,wallHeight){\r\n\t\tconst tileId = tileConf.sideId;\r\n\t\tconst configRect = tileConf.rectSide;\r\n\t\tconst setN = mv3d.getSetNumber(tileId);\r\n\t\tconst isAutotile = Tilemap.isAutotile(tileId);\r\n\t\tconst edges = [];\r\n\t\tfor (let ni=0; ni<MapCell.neighborPositions.length; ++ni){\r\n\t\t\tconst np = MapCell.neighborPositions[ni];\r\n\t\t\tconst neighborHeight = mv3d.getTileHeight(this.ox+x+np.x,this.oy+y+np.y,l);\r\n\t\t\tif(neighborHeight!==wallHeight){ edges.push(ni); }\r\n\t\t}\r\n\t\tfor (let ni=0; ni<MapCell.neighborPositions.length; ++ni){\r\n\t\t\tconst np = MapCell.neighborPositions[ni];\r\n\r\n\t\t\tconst edge = edges.includes(ni);\r\n\t\t\tif(edge&&edges.length<4&&!isAutotile){ continue; }\r\n\r\n\t\t\tconst rightSide = np.x>0||np.y>0;\r\n\t\t\tlet rot = Math.atan2(np.x, np.y)+Math.PI/2;\r\n\t\t\tif(rightSide){\r\n\t\t\t\trot-=Math.PI;\r\n\t\t\t}\r\n\r\n\t\t\tif(isAutotile&&!configRect){\r\n\t\t\t\tconst {x:bx,y:by} = this.getAutotileCorner(tileId,tileConf.realId);\r\n\t\t\t\tfor (let az=0;az<=1;++az){\r\n\t\t\t\t\tconst mesh = this.createMesh(0.5,wallHeight/2,DOUBLESIDE,true);\r\n\t\t\t\t\t//mesh.rotate(XAxis,-Math.PI/2,WORLDSPACE);\r\n\t\t\t\t\tmesh.rotate(YAxis,-rot,WORLDSPACE);\r\n\t\t\t\t\tmesh.material = mv3d.getCachedTileMaterial(setN,\r\n\t\t\t\t\t\t(edge ? (bx+rightSide*1.5) : (bx+1-rightSide*0.5) )*tileWidth(),\r\n\t\t\t\t\t\t(by+az*1.5)*tileHeight(),\r\n\t\t\t\t\t\ttileWidth()/2,\r\n\t\t\t\t\t\ttileHeight()/2,\r\n\t\t\t\t\t\tmv3d.getMaterialOptions(tileId));\r\n\t\t\t\t\tmesh.x=x+np.x/4;\r\n\t\t\t\t\tmesh.y=y+np.y/4;\r\n\t\t\t\t\tmesh.z=z-wallHeight/4-az*wallHeight/2;\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\tconst rect = configRect ? configRect : mv3d.getTileRects(tileId)[0];\r\n\t\t\t\tconst mesh = this.createMesh(0.5,wallHeight,DOUBLESIDE,true);\r\n\t\t\t\t//mesh.rotate(XAxis,-Math.PI/2,WORLDSPACE);\r\n\t\t\t\tmesh.rotate(YAxis,-rot,WORLDSPACE);\r\n\t\t\t\tmesh.material = mv3d.getCachedTileMaterial(setN,\r\n\t\t\t\t\trect.x+rect.width/2*rightSide,\r\n\t\t\t\t\trect.y,\r\n\t\t\t\t\trect.width/2,\r\n\t\t\t\t\trect.height,\r\n\t\t\t\t\tmv3d.getMaterialOptions(tileId));\r\n\t\t\t\t\tmesh.x=x+np.x/4;\r\n\t\t\t\t\tmesh.y=y+np.y/4;\r\n\t\t\t\t\tmesh.z=z-wallHeight/2;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tloadCross(tileConf,x,y,z,l,wallHeight){\r\n\t\tconst tileId = tileConf.sideId;\r\n\t\tconst configRect = tileConf.rectSide;\r\n\t\tconst setN = mv3d.getSetNumber(tileId);\r\n\t\tconst isAutotile = Tilemap.isAutotile(tileId);\r\n\t\tlet rects;\r\n\t\tif(configRect){\r\n\t\t\trects=[configRect];\r\n\t\t}else{\r\n\t\t\trects = mv3d.getTileRects(tileId);\r\n\t\t}\r\n\t\tconst rot = tileConf.shape===mv3d.configurationShapes.XCROSS ? Math.PI/4 : 0;\r\n\t\tconst partHeight = isAutotile ? wallHeight/2 : wallHeight;\r\n\t\tfor (let i=0; i<=1; ++i){\r\n\t\t\tfor (const rect of rects){\r\n\t\t\t\tconst mesh = this.createMesh(1-isAutotile/2,partHeight,DOUBLESIDE,true);\r\n\t\t\t\tmesh.x = x;\r\n\t\t\t\tmesh.y = y;\r\n\t\t\t\tmesh.z = z - (rect.oy|0)/tileHeight()*wallHeight - partHeight/2;\r\n\t\t\t\tmesh.rotate(YAxis,-Math.PI/2*i+rot,WORLDSPACE);\r\n\t\t\t\tmesh.translate(XAxis,-0.25*isAutotile+(rect.ox|0)/tileWidth(),LOCALSPACE);\r\n\t\t\t\tmesh.material = mv3d.getCachedTileMaterial(setN,rect.x,rect.y,rect.width,rect.height, mv3d.getMaterialOptions(tileId));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tgetAutotileCorner(tileId,realId=tileId){\r\n\t\tconst kind = Tilemap.getAutotileKind(tileId);\r\n\t\tlet tx = kind%8;\r\n\t\tlet ty = Math.floor(kind / 8);\r\n\t\tif(tileId===realId && mv3d.isWallTile(tileId)==1){ ++ty; }\r\n\t\tvar bx,by;\r\n\t\tbx=tx*2;\r\n\t\tby=ty;\r\n\t\tif(Tilemap.isTileA1(tileId)){\r\n\t\t\tif(kind<4){\r\n\t\t\t\tby=3*(kind%2)+1;\r\n\t\t\t\tbx=6*Math.floor(kind/2);\r\n\t\t\t}else{\r\n\t\t\t\tbx=8*Math.floor(tx/4) + (kind%2)*6;\r\n\t\t\t\tby=ty*6 + Math.floor(tx%4/2)*3 + 1-(tx%2);\r\n\t\t\t}\r\n\t\t}else if(Tilemap.isTileA2(tileId)){\r\n\t\t\tby=(ty-2)*3+1;\r\n\t\t}else if (Tilemap.isTileA3(tileId)){\r\n\t\t\tby=(ty-6)*2;\r\n\t\t}else if (Tilemap.isTileA4(tileId)){\r\n\t\t\tby=(ty-10)*2.5+(ty%2?0.5:0);\r\n\t\t}\r\n\t\treturn {x:bx,y:by};\r\n\t}\r\n}\r\nMapCell.neighborPositions = [\r\n\tnew Vector2( 0, 1),\r\n\tnew Vector2( 1, 0),\r\n\tnew Vector2( 0,-1),\r\n\tnew Vector2(-1, 0),\r\n];","import mv3d from './mv3d.js';\r\nimport { MapCell } from './mapCell.js';\r\nimport { sleep } from './util.js';\r\nimport { Vector2 } from './mod_babylon.js';\r\n\r\nObject.assign(mv3d,{\r\n\r\n    mapLoaded: false,\r\n\tclearMap(){\r\n\t\tthis.mapLoaded=false;\r\n\t\t// clear materials and textures\r\n\t\tfor (const key in this.textureCache){\r\n\t\t\tthis.textureCache[key].dispose();\r\n\t\t}\r\n\t\tfor (const key in this.materialCache){\r\n\t\t\tthis.materialCache[key].dispose();\r\n\t\t}\r\n\t\tthis.animatedTextures.length=0;\r\n\t\tthis.textureCache={};\r\n\t\tthis.materialCache={};\r\n\t\t// clear map cells\r\n\t\tfor (const key in this.cells){\r\n\t\t\tthis.cells[key].dispose(false,true);\r\n\t\t}\r\n\t\tthis.cells={};\r\n\t\tfor (const char of this.characters){\r\n\t\t\tchar.dispose(false,true);\r\n\t\t}\r\n\t\tthis.characters.length=0;\r\n\t},\r\n\r\n\tloadMap(){\r\n\t\tthis.loadMapSettings();\r\n\t\t//this.cameraStick.x=$gamePlayer._realX;\r\n\t\t//this.cameraStick.y=$gamePlayer._realY;\r\n\t\tthis.updateBlenders();\r\n\t\tthis.updateMap();\r\n\t\tthis.createCharacters();\r\n\t},\r\n\r\n\tasync updateMap(){\r\n\t\tif(this.mapUpdating){ return; }\r\n\t\tthis.mapLoaded=true;\r\n\t\tthis.mapUpdating=true;\r\n\t\t// unload Far cells? implement if needed.\r\n\t\t// get range of cells based on render distance\r\n\t\tconst bounds = {\r\n\t\t\tleft:Math.floor((this.cameraStick.x-this.RENDER_DIST)/this.CELL_SIZE),\r\n\t\t\tright:Math.floor((this.cameraStick.x+this.RENDER_DIST)/this.CELL_SIZE),\r\n\t\t\ttop:Math.floor((this.cameraStick.y-this.RENDER_DIST)/this.CELL_SIZE),\r\n\t\t\tbottom:Math.floor((this.cameraStick.y+this.RENDER_DIST)/this.CELL_SIZE),\r\n\t\t}\r\n\t\t//clamp cell range to map\r\n\t\tif(!$gameMap.isLoopHorizontal()){\r\n\t\t\tbounds.left=Math.max(0,bounds.left);\r\n\t\t\tbounds.right=Math.min(bounds.right,Math.floor($gameMap.width()/mv3d.CELL_SIZE));\r\n\t\t}\r\n\t\tif(!$gameMap.isLoopVertical()){\r\n\t\t\tbounds.top=Math.max(0,bounds.top);\r\n\t\t\tbounds.bottom=Math.min(bounds.bottom,Math.floor($gameMap.height()/mv3d.CELL_SIZE));\r\n\t\t}\r\n\t\tconst cellsToLoad=[];\r\n\t\tfor (let ix=bounds.left;ix<=bounds.right;++ix)\r\n\t\tfor (let iy=bounds.top;iy<=bounds.bottom;++iy){\r\n\t\t\tlet cx=ix, cy=iy;\r\n\t\t\tif($gameMap.isLoopHorizontal()){ cx = cx.mod(Math.ceil($gameMap.width()/mv3d.CELL_SIZE)); }\r\n\t\t\tif($gameMap.isLoopVertical()){ cy = cy.mod(Math.ceil($gameMap.height()/mv3d.CELL_SIZE)); }\r\n\t\t\tcellsToLoad.push(new Vector2(cx,cy));\r\n\t\t}\r\n\t\tconst cameraCellPos = new Vector2(Math.round(this.cameraStick.x/this.CELL_SIZE),Math.round(this.cameraStick.y/this.CELL_SIZE));\r\n\t\tcellsToLoad.sort((a,b)=>Vector2.DistanceSquared(a,cameraCellPos)-Vector2.DistanceSquared(b,cameraCellPos));\r\n\t\tfor (const cellpos of cellsToLoad){\r\n\t\t\tlet {x:cx,y:cy} = cellpos;\r\n\t\t\tthis.loadMapCell(cx,cy);\r\n\t\t\tawait sleep(1);\r\n\t\t\tif(!this.mapLoaded){ this.mapUpdating=false; return; }\r\n\t\t}\r\n\t\tthis.mapUpdating=false;\r\n\t},\r\n\r\n\tloadMapCell(cx,cy){\r\n\t\tconst key = [cx,cy].toString();\r\n\t\tif(key in this.cells){ return; }\r\n\t\tconst cell = new MapCell(cx,cy);\r\n\t\tthis.cells[key]=cell;\r\n\t},\r\n\r\n});","import mv3d from './mv3d.js';\r\nimport { Texture, StandardMaterial, Color3 } from './mod_babylon.js';\r\nimport { tileWidth, tileHeight } from './util.js';\r\n\r\nObject.assign(mv3d,{\r\n\r\n\tanimatedTextures:[],\r\n\ttextureCache:{},\r\n\tmaterialCache:{},\r\n\r\n\tgetCachedTileTexture(setN,x,y,w,h){\r\n\t\tconst key = `${setN}|${x},${y}|${w},${h}`;\r\n\t\tif(key in this.textureCache){\r\n\t\t\treturn this.textureCache[key];\r\n\t\t}\r\n\t\tconst tsName = $gameMap.tileset().tilesetNames[setN];\r\n\t\tif(!tsName){\r\n\t\t\treturn this.getErrorTexture();\r\n\t\t}\r\n\t\tconst textureSrc=`img/tilesets/${tsName}.png`;\r\n\t\tconst texture = new Texture(textureSrc,this.scene);\r\n\t\ttexture.hasAlpha=true;\r\n\t\ttexture.onLoadObservable.addOnce(()=>{\r\n\t\t\tif(this.textureCache[key]!==texture){ return; }\r\n\t\t\ttexture.crop(x,y,w,h);\r\n\t\t\ttexture.updateSamplingMode(1);\r\n\t\t\t//texture.anisotropicFilteringLevel=4;\r\n\t\t\t//texture.noMipmap=false;\r\n\t\t\tif(setN===0){\r\n\t\t\t\tconst tx = x/tileWidth();\r\n\t\t\t\tconst ty = y/tileHeight();\r\n\t\t\t\tif(tx<6||tx>=8||ty>=6){\r\n\t\t\t\t\tconst isWaterfall = tx>=6&&tx<8||tx>=14;\r\n\t\t\t\t\ttexture.animX = isWaterfall ? 0 : 2;\r\n\t\t\t\t\ttexture.animY = isWaterfall ? 1 : 0;\r\n\t\t\t\t\ttexture.frameData={x:x,y:y,w:w,h:h};\r\n\t\t\t\t\tthis.animatedTextures.push(texture);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.textureCache[key]=texture;\r\n\t\treturn texture;\r\n\t},\r\n\r\n\tgetErrorTexture(){\r\n\t\tif(this.errorTexture){ return this.errorTexture; }\r\n\t\tthis.errorTexture = new Texture(\"MV3D/errorTexture.png\",this.scene);\r\n\t\treturn this.errorTexture;\r\n\t},\r\n\r\n\tgetBushAlphaTexture(){\r\n\t\tif(this.bushAlphaTexture){ return this.bushAlphaTexture; }\r\n\t\tthis.bushAlphaTexture = new Texture(\"MV3D/bushAlpha.png\",this.scene);\r\n\t\tthis.bushAlphaTexture.getAlphaFromRGB=true;\r\n\t\treturn this.bushAlphaTexture;\r\n\t},\r\n\r\n\tgetCachedTileMaterial(setN,x,y,w,h,options={}){\r\n\t\tthis.processMaterialOptions(options);\r\n\t\tconst key = `${setN}|${x},${y}|${w},${h}|${this.getExtraBit(options)}`;\r\n\t\tif(key in this.materialCache){\r\n\t\t\treturn this.materialCache[key];\r\n\t\t}\r\n\t\tconst texture = this.getCachedTileTexture(setN,x,y,w,h);\r\n\t\tconst material = new StandardMaterial(key, this.scene);\r\n\t\tmaterial.diffuseTexture=texture;\r\n\t\tif(options.transparent){ // alpha blending\r\n\t\t\t// materials with alpha blending don't cast shadows.\r\n\t\t\tmaterial.opacityTexture=texture;\r\n\t\t\tmaterial.alpha=options.alpha;\r\n\t\t}\r\n\t\tmaterial.alphaCutOff = mv3d.ALPHA_CUTOFF;\r\n\t\tmaterial.ambientColor.set(1,1,1);\r\n\t\tmaterial.emissiveColor.set(options.glow,options.glow,options.glow);\r\n\t\tmaterial.specularColor.set(0,0,0);\r\n\t\tthis.materialCache[key]=material;\r\n\t\treturn material;\r\n\t},\r\n\r\n\tprocessMaterialOptions(options){\r\n\t\tif('alpha' in options){\r\n\t\t\toptions.alpha = Math.round(options.alpha*7)/7;\r\n\t\t\tif(options.alph<1){\r\n\t\t\t\toptions.transparent=true;\r\n\t\t\t}\r\n\t\t}else{ options.alpha=1; }\r\n\t\tif('glow' in options){\r\n\t\t\toptions.glow = Math.round(options.glow*7)/7;\r\n\t\t}else{ options.glow=0; }\r\n\t},\r\n\r\n\tgetExtraBit(options){\r\n\t\tlet extra = 0;\r\n\t\textra|=Boolean(options.transparent)<<0;\r\n\t\textra|=7-options.alpha*7<<1;\r\n\t\textra|=options.glow*7<<1;\r\n\t\treturn extra.toString(36);\r\n\t},\r\n\r\n\t// animations\r\n\r\n\tlastAnimUpdate:0,\r\n\tanimXFrame:0,\r\n\tanimYFrame:0,\r\n\tanimDirection:1,\r\n\tupdateAnimations(){\r\n\t\tif( performance.now()-this.lastAnimUpdate <= this.ANIM_DELAY){ return; }\r\n\t\tthis.lastAnimUpdate=performance.now();\r\n\r\n\t\tif(this.animXFrame<=0){\r\n\t\t\tthis.animDirection=1;\r\n\t\t}else if(this.animXFrame>=2){\r\n\t\t\tthis.animDirection=-1;\r\n\t\t}\r\n\t\tthis.animXFrame += this.animDirection;\r\n\t\tthis.animYFrame=(this.animYFrame+1)%3;\r\n\t\tfor (const texture of this.animatedTextures){\r\n\t\t\ttexture.crop(\r\n\t\t\t\ttexture.frameData.x+texture.animX*this.animXFrame*tileWidth(),\r\n\t\t\t\ttexture.frameData.y+texture.animY*this.animYFrame*tileHeight(),\r\n\t\t\t\ttexture.frameData.w,\r\n\t\t\t\ttexture.frameData.h,\r\n\t\t\t);\r\n\t\t}\r\n\t},\r\n\r\n});","import mv3d from './mv3d.js';\r\nimport { TransformNode, MeshBuilder, FRONTSIDE, Texture, StandardMaterial, Color3, Mesh, WORLDSPACE, Vector2, SpotLight, Vector3, PointLight, LOCALSPACE, DOUBLESIDE, Plane } from \"./mod_babylon.js\";\r\nimport { relativeNumber, ZAxis, YAxis, tileSize, degtorad, XAxis } from './util.js';\r\nimport { ColorBlender, Blender } from './blenders.js';\r\n\r\nObject.assign(mv3d,{\r\n\tcreateCharacters(){\r\n\t\tconst events = $gameMap.events();\r\n\t\tfor (const event of events){\r\n\t\t\tthis.createCharacterFor(event,0);\r\n\t\t}\r\n\t\tconst vehicles = $gameMap.vehicles();\r\n\t\tfor (const vehicle of vehicles){\r\n\t\t\tthis.createCharacterFor(vehicle,1);\r\n\t\t}\r\n\t\tconst followers = $gamePlayer.followers()._data;\r\n\t\tfor (let f=followers.length-1; f>=0; --f){\r\n\t\t\tthis.createCharacterFor(followers[f],29-f);\r\n\t\t}\r\n\t\tthis.createCharacterFor($gamePlayer,30);\r\n\t},\r\n\r\n\tcreateCharacterFor(char,order){\r\n\t\tif(!char.mv3d_sprite){\r\n\t\t\tconst sprite = new Character(char,order);\r\n\t\t\tObject.defineProperty(char,'mv3d_sprite',{\r\n\t\t\t\tvalue:sprite,\r\n\t\t\t\tconfigurable:true,\r\n\t\t\t});\r\n\t\t\tthis.characters.push(sprite);\r\n\t\t\treturn sprite;\r\n\t\t}\r\n\t\treturn char.mv3d_sprite;\r\n\t},\r\n\r\n\tupdateCharacters(){\r\n\t\tfor(const char of this.characters){\r\n\t\t\tchar.update();\r\n\t\t}\r\n\t},\r\n\r\n\tsetupSpriteMeshes(){\r\n\t\tSprite.Meshes = {};\r\n\t\tSprite.Meshes.FLAT=Mesh.MergeMeshes([MeshBuilder.CreatePlane('sprite mesh',{ sideOrientation: DOUBLESIDE},mv3d.scene).rotate(XAxis,Math.PI/2,WORLDSPACE)]);\r\n\t\tSprite.Meshes.SPRITE=Mesh.MergeMeshes([MeshBuilder.CreatePlane('sprite mesh',{sideOrientation: DOUBLESIDE},mv3d.scene).translate(YAxis,0.5,WORLDSPACE)]);\r\n\t\tSprite.Meshes.CROSS=Mesh.MergeMeshes([\r\n\t\t\tSprite.Meshes.SPRITE.clone(),\r\n\t\t\tSprite.Meshes.SPRITE.clone().rotate(YAxis,Math.PI/2,WORLDSPACE),\r\n\t\t]);\r\n\r\n\t\tSprite.Meshes.SHADOW=Sprite.Meshes.FLAT.clone('shadow mesh');\r\n\t\tconst shadowTexture = new Texture(\"MV3D/shadow.png\");\r\n\t\tconst shadowMaterial = new StandardMaterial('shadow material', mv3d.scene);\r\n\t\tshadowMaterial.diffuseTexture=shadowTexture;\r\n\t\tshadowMaterial.opacityTexture=shadowTexture;\r\n\t\tSprite.Meshes.SHADOW.material=shadowMaterial;\r\n\t\t\r\n\t\tfor (const key in Sprite.Meshes){\r\n\t\t\tmv3d.scene.removeMesh(Sprite.Meshes[key]);\r\n\t\t}\r\n\t},\r\n});\r\n\r\n\r\nclass Sprite extends TransformNode{\r\n\tconstructor(){\r\n\t\tsuper('sprite',mv3d.scene);\r\n\t\tthis.spriteOrigin = new TransformNode('sprite origin',mv3d.scene);\r\n\t\tthis.spriteOrigin.parent=this;\r\n\t\tthis.mesh = Sprite.Meshes.FLAT.clone();\r\n\t\tthis.mesh.parent = this.spriteOrigin;\r\n\t}\r\n\tsetMaterial(src){\r\n\t\tthis.disposeMaterial();\r\n\t\tthis.texture = new Texture(src,mv3d.scene);\r\n\t\tthis.bitmap = this.texture._texture;\r\n\t\tthis.texture.hasAlpha=true;\r\n\t\tthis.texture.onLoadObservable.addOnce(()=>this.onTextureLoaded());\r\n\t\tthis.material = new StandardMaterial('sprite material',mv3d.scene);\r\n\t\tthis.material.diffuseTexture=this.texture;\r\n\t\tthis.material.alphaCutOff = mv3d.ALPHA_CUTOFF;\r\n\t\tthis.material.ambientColor.set(1,1,1);\r\n\t\tthis.material.specularColor.set(0,0,0);\r\n\t\tthis.mesh.material=this.material;\r\n\t}\r\n\tonTextureLoaded(){\r\n\t\tthis.texture.updateSamplingMode(1);\r\n\t}\r\n\tdisposeMaterial(){\r\n\t\tif(this.material){\r\n\t\t\tthis.material.dispose(true,true);\r\n\t\t\tthis.material=null;\r\n\t\t\tthis.texture=null;\r\n\t\t\tthis.bitmap=null;\r\n\t\t}\r\n\t}\r\n\tdispose(...args){\r\n\t\tthis.disposeMaterial();\r\n\t\tsuper.dispose(...args);\r\n\t}\r\n}\r\n\r\nclass Character extends Sprite{\r\n\tconstructor(char,order){\r\n\t\tsuper();\r\n\t\tthis.order=order;\r\n\t\tthis.mesh.order=this.order;\r\n\t\tthis.mesh.character=this;\r\n\t\tthis._character=this.char=char;\r\n\t\tthis.charName='';\r\n\t\tthis.charIndex=0;\r\n\r\n\t\tthis.updateCharacter();\r\n\t\tthis.updateShape();\r\n\r\n\t\tthis.isVehicle = this.char instanceof Game_Vehicle;\r\n\t\tthis.isBoat = this.isVehicle && this.char.isBoat();\r\n\t\tthis.isShip = this.isVehicle && this.char.isShip();\r\n\t\tthis.isAirship = this.isVehicle && this.char.isAirship();\r\n\t\tthis.isEvent = this.char instanceof Game_Event;\r\n\t\tthis.isPlayer = this.char instanceof Game_Player;\r\n\t\tthis.isFollower = this.char instanceof Game_Follower;\r\n\r\n\t\tif(this.isEvent){\r\n\t\t\tthis.eventConfigure();\r\n\t\t}\r\n\r\n\t\tthis.elevation = 0;\r\n\r\n\t\tif(!this.char.mv3d_blenders){ this.char.mv3d_blenders={}; }\r\n\r\n\t\tif(mv3d.CHARACTER_SHADOWS){\r\n\t\t\t//this.shadow = Sprite.Meshes.SHADOW.createInstance();\r\n\t\t\tthis.shadow = Sprite.Meshes.SHADOW.clone();\r\n\t\t\tthis.shadow.parent=this.spriteOrigin;\r\n\t\t}\r\n\r\n\t\tthis.lightOrigin = new TransformNode('light origin',mv3d.scene);\r\n\t\tthis.lightOrigin.parent=this;\r\n\t\tthis.setupLights();\r\n\t}\r\n\r\n\tisTextureReady(){\r\n\t\treturn Boolean(this.texture && this.texture.isReady());\r\n\t}\r\n\r\n\tsetTileMaterial(){\r\n\t\tconst setN = mv3d.getSetNumber(this._tileId);\r\n\t\tconst tsName = $gameMap.tileset().tilesetNames[setN];\r\n\t\tif(tsName){\r\n\t\t\tconst textureSrc=`img/tilesets/${tsName}.png`;\r\n\t\t\tthis.setMaterial(textureSrc);\r\n\t\t}else{\r\n\t\t\tthis.setMaterial(\"MV3D/errorTexture.png\");\r\n\t\t}\r\n\t}\r\n\r\n\tonTextureLoaded(){\r\n\t\tsuper.onTextureLoaded();\r\n\t\tthis.updateFrame();\r\n\t\tthis.updateScale();\r\n\t}\r\n\r\n\tupdateCharacter(){\r\n\t\tthis._tilesetId = $gameMap.tilesetId();\r\n\t\tthis._tileId = this._character.tileId();\r\n\t\tthis._characterName = this._character.characterName();\r\n\t\tthis._characterIndex = this._character.characterIndex();\r\n\t\tthis._isBigCharacter = ImageManager.isBigCharacter(this._characterName);\r\n\t\tif(this._tileId>0){\r\n\t\t\tthis.setTileMaterial(this._tileId);\r\n\t\t}else if(this._characterName){\r\n\t\t\tthis.setMaterial(`img/characters/${this._characterName}.png`);\r\n\t\t}\r\n\t}\r\n\tupdateCharacterFrame(){\r\n\t\tthis.px=this.characterPatternX();\r\n\t\tthis.py=this.characterPatternY();\r\n\t\tif(!this.isTextureReady()){ return; }\r\n\t\tconst pw = this.patternWidth();\r\n\t\tconst ph = this.patternHeight();\r\n\t\tconst sx = (this.characterBlockX() + this.px) * pw;\r\n\t\tconst sy = (this.characterBlockY() + this.py) * ph;\r\n\t\tthis.setFrame(sx,sy,pw,ph);\r\n\t}\r\n\tpatternChanged(){\r\n\t\treturn this.px!==this.characterPatternX() || this.py!==this.characterPatternY();\r\n\t}\r\n\tcharacterPatternY(){\r\n\t\tif(this.isEvent && this.char.isObjectCharacter()){\r\n\t\t\treturn this.char.direction()/2-1;\r\n\t\t}\r\n\t\tlet dir = mv3d.transformDirectionYaw(this.char.direction());\r\n\t\treturn dir/2-1;\r\n\t}\r\n\r\n\tsetFrame(x,y,w,h){\r\n\t\tif(!this.isTextureReady()){ return; }\r\n\t\tthis.texture.crop(x,y,w,h);\r\n\t}\r\n\r\n\tupdateScale(){\r\n\t\tif(!this.isTextureReady()){ return; }\r\n\t\tconst configScale = this.getConfig('scale',new Vector2(1,1));\r\n\t\tlet scale = 1;\r\n\t\tif(this.isVehicle){\r\n\t\t\tconst settings = mv3d[`${this.char._type.toUpperCase()}_SETTINGS`];\r\n\t\t\tscale = mv3d.loadData( `${this.char._type}_scale`, settings.scale );\r\n\t\t}\r\n\t\tconst xscale = this.patternWidth()/tileSize() * configScale.x * scale;\r\n\t\tconst yscale = this.patternHeight()/tileSize() * configScale.y * scale;\r\n\t\tthis.mesh.scaling.set(xscale,yscale,yscale);\r\n\t}\r\n\r\n\tgetConfig(key,dfault=undefined){\r\n\t\tif(!this.settings_event){ return dfault; }\r\n\t\tif(key in this.settings_event_page){\r\n\t\t\treturn this.settings_event_page[key];\r\n\t\t}else if(key in this.settings_event){\r\n\t\t\treturn this.settings_event[key];\r\n\t\t}\r\n\t\treturn dfault;\r\n\t}\r\n\thasConfig(key){\r\n\t\tif(!this.settings_event){ return false; }\r\n\t\treturn key in this.settings_event_page || key in this.settings_event;\r\n\t}\r\n\r\n\teventConfigure(){\r\n\t\tif(!this.settings_event){\r\n\t\t\tthis.settings_event={};\r\n\t\t\tconst note = this.char.event().note;\r\n\t\t\tmv3d.readConfigurationFunctions(\r\n\t\t\t\tmv3d.readConfigurationTags(note),\r\n\t\t\t\tmv3d.eventConfigurationFunctions,\r\n\t\t\t\tthis.settings_event,\r\n\t\t\t);\r\n\t\t}\r\n\t\tthis.settings_event_page={};\r\n\t\tconst page = this.char.page();\r\n\t\tif(!page){ return; }\r\n\t\tlet comments = '';\r\n\t\tfor (const command of page.list){\r\n\t\t\tif(command.code===108||command.code===408){\r\n\t\t\t\tcomments+=command.parameters[0];\r\n\t\t\t}\r\n\t\t}\r\n\t\tmv3d.readConfigurationFunctions(\r\n\t\t\tmv3d.readConfigurationTags(comments),\r\n\t\t\tmv3d.eventConfigurationFunctions,\r\n\t\t\tthis.settings_event_page,\r\n\t\t);\r\n\t\tthis.updateScale();\r\n\t\tthis.updateShape();\r\n\r\n\t\tif(this.char.mv3d_needsConfigure){\r\n\t\t\tthis.char.mv3d_needsConfigure=false;\r\n\t\t}else{ return; }\r\n\r\n\t\tif('pos' in this.settings_event_page){\r\n\t\t\tconst event=this.char.event();\r\n\t\t\tconst pos = this.settings_event_page.pos;\r\n\t\t\tthis.char.locate(\r\n\t\t\t\trelativeNumber(event.x,pos.x),\r\n\t\t\t\trelativeNumber(event.y,pos.y),\r\n\t\t\t);\r\n\t\t}\r\n\t\t/*\r\n\t\tthis.setupEventLights();\r\n\r\n\t\tif('lamp' in this.settings_event_page){\r\n\t\t\tconst lampConfig = this.getConfig('lamp');\r\n\t\t\tthis.blendLampColor.setValue(lampConfig.color,0.5);\r\n\t\t\tthis.blendLampIntensity.setValue(lampConfig.intensity,0.5);\r\n\t\t\tthis.blendLampDistance.setValue(lampConfig.distance,0.5);\r\n\t\t}\r\n\t\tif('flashlight' in this.settings_event_page){\r\n\t\t\tconst flashlightConfig = this.getConfig('flashlight');\r\n\t\t\tthis.blendFlashlightColor.setValue(flashlightConfig.color,0.5);\r\n\t\t\tthis.blendFlashlightIntensity.setValue(flashlightConfig.intensity,0.5);\r\n\t\t\tthis.blendFlashlightDistance.setValue(flashlightConfig.distance,0.5);\r\n\t\t\tthis.blendFlashlightAngle.setValue(flashlightConfig.angle,0.5);\r\n\t\t\tthis.blendFlashlightPitch.setValue(this.getConfig('flashlightPitch',90),0.25);\r\n\t\t\tthis.flashlightTargetYaw=this.getConfig('flashlightYaw','+0');\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tsetupMesh(){\r\n\t\tthis.mesh.parent = this.spriteOrigin;\r\n\t\tthis.mesh.character=this;\r\n\t\tthis.mesh.order=this.order;\r\n\t\tif(this.material){\r\n\t\t\tthis.mesh.material=this.material;\r\n\t\t}\r\n\t\tif(this.flashlight){\r\n\t\t\tthis.flashlight.excludedMeshes.splice(0,Infinity);\r\n\t\t\tthis.flashlight.excludedMeshes.push(this.mesh);\r\n\t\t}\r\n\t}\r\n\r\n\tsetupLights(){\r\n\t\tif('flashlightColor' in this.char.mv3d_blenders){\r\n\t\t\tthis.setupFlashlight();\r\n\t\t}\r\n\t\tif('lampColor' in this.char.mv3d_blenders){\r\n\t\t\tthis.setupLamp();\r\n\t\t}\r\n\t}\r\n\r\n\tsetupFlashlight(){\r\n\t\tif(this.flashlight){ return; }\r\n\t\tconst config = this.getConfig('flashlight',{\r\n\t\t\tcolor:0xffffff,\r\n\t\t\tintensity:1,\r\n\t\t\tdistance:mv3d.LIGHT_DIST,\r\n\t\t\tangle:mv3d.LIGHT_ANGLE,\r\n\t\t});\r\n\t\tthis.blendFlashlightColor = this.makeColorBlender('flashlightColor',config.color);\r\n\t\tthis.blendFlashlightIntensity = this.makeBlender('flashlightIntensity',config.intensity);\r\n\t\tthis.blendFlashlightDistance = this.makeBlender('flashlightDistance',config.distance);\r\n\t\tthis.blendFlashlightAngle = this.makeBlender('flashlightAngle',config.angle);\r\n\t\tthis.flashlight = new SpotLight('flashlight',Vector3.Zero(),Vector3.Zero(),\r\n\t\t\tdegtorad(this.blendFlashlightAngle.targetValue()),0,mv3d.scene);\r\n\t\tthis.flashlight.exponent = 64800*Math.pow(this.blendFlashlightAngle.targetValue(),-2);\r\n\t\tthis.flashlight.range = this.blendFlashlightDistance.targetValue();\r\n\t\tthis.flashlight.intensity=this.blendFlashlightIntensity.targetValue();\r\n\t\tthis.flashlight.diffuse.set(...this.blendFlashlightColor.targetComponents());\r\n\t\t//this.flashlight.projectionTexture = mv3d.getFlashlightTexture();\r\n\t\tthis.flashlight.direction.y=-1;\r\n\t\tthis.flashlightOrigin=new TransformNode('flashlight origin',mv3d.scene);\r\n\t\tthis.flashlightOrigin.parent=this.lightOrigin;\r\n\t\tthis.flashlight.parent=this.flashlightOrigin;\r\n\t\tthis.blendFlashlightPitch = this.makeBlender('flashlightPitch',70);\r\n\t\tthis.blendFlashlightYaw = this.makeBlender('flashlightYaw', 0);\r\n\t\tthis.blendFlashlightYaw.cycle=360;\r\n\t\tthis.flashlightTargetYaw=this.getConfig('flashlightYaw','+0');\r\n\t\tthis.updateFlashlightDirection();\r\n\t\tthis.setupMesh();\r\n\t}\r\n\r\n\tsetupLamp(){\r\n\t\tif(this.lamp){ return; }\r\n\t\tconst config = this.getConfig('lamp',{\r\n\t\t\tcolor:0xffffff,\r\n\t\t\tintensity:1,\r\n\t\t\tdistance:mv3d.LIGHT_DIST,\r\n\t\t});\r\n\t\tthis.blendLampColor = this.makeColorBlender('lampColor',config.color);\r\n\t\tthis.blendLampIntensity = this.makeBlender('lampIntensity',config.intensity);\r\n\t\tthis.blendLampDistance = this.makeBlender('lampDistance',config.distance);\r\n\t\tthis.lamp = new PointLight('lamp',Vector3.Zero(),mv3d.scene);\r\n\t\tthis.lamp.diffuse.set(...this.blendLampColor.targetComponents());\r\n\t\tthis.lamp.intensity=this.blendLampIntensity.targetValue();\r\n\t\tthis.lamp.range=this.blendLampDistance.targetValue();\r\n\t\tthis.lamp.parent=this.lightOrigin;\r\n\t}\r\n\r\n\tupdateFlashlightDirection(){\r\n\t\t/*\r\n\t\tconst yaw = degtorad(this.blendFlashlightYaw.currentValue());\r\n\t\tconst pitch = degtorad(this.blendFlashlightPitch.currentValue());\r\n\t\tthis.flashlight.direction.x=Math.sin(yaw)*Math.sin(pitch);\r\n\t\tthis.flashlight.direction.z=-Math.cos(yaw)*Math.sin(pitch);\r\n\t\tthis.flashlight.direction.y=-Math.cos(pitch);\r\n\t\t*/\r\n\t\tthis.flashlightOrigin.yaw=this.blendFlashlightYaw.currentValue();\r\n\t\tthis.flashlightOrigin.pitch=-this.blendFlashlightPitch.currentValue();\r\n\t\tthis.flashlightOrigin.position.set(0,0,0);\r\n\t\tlet flashlightOffset = Math.tan(degtorad(90-this.blendFlashlightAngle.currentValue()-Math.max(90,this.blendFlashlightPitch.currentValue())+90))*mv3d.LIGHT_HEIGHT;\r\n\t\tflashlightOffset = Math.max(0,Math.min(1,flashlightOffset));\r\n\t\tthis.flashlight.range+=flashlightOffset;\r\n\t\tthis.flashlightOrigin.translate(YAxis,flashlightOffset,LOCALSPACE);\r\n\t}\r\n\r\n\tupdateLights(){\r\n\t\tif(this.flashlight){\r\n\t\t\tconst flashlightYaw = 180+relativeNumber( mv3d.dirToYaw( this.char.direction() ), this.flashlightTargetYaw);\r\n\t\t\tif(flashlightYaw !== this.blendFlashlightYaw.targetValue()){\r\n\t\t\t\tthis.blendFlashlightYaw.setValue(flashlightYaw,0.25);\r\n\t\t\t}\r\n\t\t\tif(this.blendFlashlightColor.update()|this.blendFlashlightIntensity.update()\r\n\t\t\t|this.blendFlashlightDistance.update()|this.blendFlashlightAngle.update()\r\n\t\t\t|this.blendFlashlightYaw.update()|this.blendFlashlightPitch.update()){\r\n\t\t\t\tthis.flashlight.diffuse.set(...this.blendFlashlightColor.currentComponents());\r\n\t\t\t\tthis.flashlight.intensity=this.blendFlashlightIntensity.currentValue();\r\n\t\t\t\tthis.flashlight.range=this.blendFlashlightDistance.currentValue();\r\n\t\t\t\tthis.flashlight.angle=degtorad(this.blendFlashlightAngle.currentValue());\r\n\t\t\t\tthis.flashlight.exponent = 64800*Math.pow(this.blendFlashlightAngle.targetValue(),-2);\r\n\t\t\t\tthis.updateFlashlightDirection();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(this.lamp){\r\n\t\t\tif(this.blendLampColor.update()|this.blendLampIntensity.update()|this.blendLampDistance.update()){\r\n\t\t\t\tthis.lamp.diffuse.set(...this.blendLampColor.currentComponents());\r\n\t\t\t\tthis.lamp.intensity=this.blendLampIntensity.currentValue();\r\n\t\t\t\tthis.lamp.range=this.blendLampDistance.currentValue();\r\n\t\t\t}\r\n\t\t}\r\n\t\t/*\r\n\t\tif(this.flashlight&&this.lamp){\r\n\t\t\tconst flashlightComponents = this.blendFlashlightColor.currentComponents().map(c=>c*this.flashlight.intensity/4);\r\n\t\t\tconst lampComponents = this.blendLampColor.currentComponents().map(c=>c*this.lamp.intensity/4);\r\n\t\t\tthis.material.emissiveColor.set(...flashlightComponents.map((c,i)=>(c+lampComponents[i])/2));\r\n\r\n\t\t}else if(this.flashlight){\r\n\t\t\tthis.material.emissiveColor.set(...this.blendFlashlightColor.currentComponents().map(c=>c*this.flashlight.intensity/4));\r\n\t\t}else if(this.lamp){\r\n\t\t\tthis.material.emissiveColor.set(...this.blendLampColor.currentComponents().map(c=>c*this.lamp.intensity/4));\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tmakeBlender(key,dfault,clazz=Blender){\r\n\t\tif(key in this.char.mv3d_blenders){\r\n\t\t\tdfault = this.char.mv3d_blenders[key];\r\n\t\t}else{\r\n\t\t\tthis.char.mv3d_blenders[key]=dfault;\r\n\t\t}\r\n\t\tconst blender=new clazz(key,dfault);\r\n\t\tblender.storageLocation=()=>this.char.mv3d_blenders;\r\n\t\treturn blender;\r\n\t}\r\n\tmakeColorBlender(key,dfault){\r\n\t\treturn this.makeBlender(key,dfault,ColorBlender);\r\n\t}\r\n\r\n\thasBush(){\r\n\t\tif(this.isEvent){\r\n\t\t\treturn this.getConfig('bush',!this._tileId);\r\n\t\t}\r\n\t\tif(this.isVehicle){\r\n\t\t\treturn mv3d.VEHICLE_BUSH;\r\n\t\t}\r\n\t\treturn true;\r\n\t}\r\n\r\n\tgetShape(){\r\n\t\treturn this.getConfig('shape',\r\n\t\t\tthis.char.isTile() ? mv3d.configurationShapes.FLAT : mv3d.EVENT_SHAPE\r\n\t\t);\r\n\t}\r\n\tupdateShape(){\r\n\t\tconst newshape = this.getShape();\r\n\t\tif(this.shape === newshape){ return; }\r\n\t\tthis.shape=newshape;\r\n\t\t//let backfaceCulling=true;\r\n\t\tlet geometry = Sprite.Meshes.SPRITE;\r\n\t\tconst shapes = mv3d.configurationShapes;\r\n\t\tswitch(this.shape){\r\n\t\tcase shapes.FLAT:\r\n\t\t\tgeometry = Sprite.Meshes.FLAT;\r\n\t\t\t//if(this.char._priorityType===2||this.hasConfig('height')||this.hasConfig('z')){\r\n\t\t\t//\tbackfaceCulling=false;\r\n\t\t\t//}\r\n\t\t\tbreak;\r\n\t\tcase shapes.CROSS:\r\n\t\t\tgeometry = Sprite.Meshes.CROSS;\r\n\t\t\t//backfaceCulling=false;\r\n\t\t\tbreak;\r\n\t\tcase shapes.FENCE:\r\n\t\t\t//backfaceCulling=false;\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\tthis.mesh.dispose();\r\n\t\tthis.mesh=geometry.clone();\r\n\t\t//this.material.backfaceCulling=backfaceCulling;\r\n\t\tthis.setupMesh();\r\n\t}\r\n\r\n\tupdate(){\r\n\t\tif(this.char._erased){\r\n\t\t\tthis.dispose();\r\n\t\t}\r\n\r\n\t\tthis.visible=this.char.mv_sprite.visible;\r\n\t\tif(typeof this.char.isVisible === 'function'){\r\n\t\t\tthis.visible=this.visible&&this.char.isVisible();\r\n\t\t}\r\n\t\tif(!this.material){\r\n\t\t\tthis.visible=false;\r\n\t\t}\r\n\t\tif(!this._isEnabled){\r\n\t\t\tif(this.visible){ this.setEnabled(true); }\r\n\t\t}else{\r\n\t\t\tif(!this.visible){ this.setEnabled(false); }\r\n\t\t}\r\n\t\tif(!this._isEnabled){ return; }\r\n\r\n\t\tif(this.isImageChanged()){\r\n\t\t\tthis.updateCharacter();\r\n\t\t}\r\n\t\tif(this.patternChanged()){\r\n\t\t\tthis.updateFrame();\r\n\t\t}\r\n\r\n\t\tif(this.shape===mv3d.configurationShapes.SPRITE){\r\n\t\t\tthis.mesh.pitch = mv3d.blendCameraPitch.currentValue()-90;\r\n\t\t\tthis.mesh.yaw = mv3d.blendCameraYaw.currentValue();\r\n\t\t}else if(this.shape===mv3d.configurationShapes.TREE){\r\n\t\t\tthis.mesh.pitch=0;\r\n\t\t\tthis.mesh.yaw = mv3d.blendCameraYaw.currentValue();\r\n\t\t}else{\r\n\t\t\tthis.mesh.pitch=0;\r\n\t\t\tthis.mesh.yaw=this.getConfig('rot',0);\r\n\t\t}\r\n\t\t//this.mesh.renderOutline=true;\r\n\t\t//this.mesh.outlineWidth=1;\r\n\r\n\t\tthis.bush = Boolean(this.char.bushDepth());\r\n\t\tif(this.bush && this.hasBush()){\r\n\t\t\tif(!this.material.opacityTexture){\r\n\t\t\t\tthis.material.opacityTexture=mv3d.getBushAlphaTexture();\r\n\t\t\t\tthis.material.useAlphaFromDiffuseTexture=true;\r\n\t\t\t}\r\n\t\t}else{\r\n\t\t\tif(this.material.opacityTexture){\r\n\t\t\t\tthis.material.opacityTexture=null;\r\n\t\t\t\tthis.material.useAlphaFromDiffuseTexture=false;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.tileHeight = mv3d.getWalkHeight(this.char._realX,this.char._realY);\r\n\r\n\t\tthis.updatePosition();\r\n\t\tthis.updateElevation();\r\n\t\tif(this.shadow){ this.updateShadow(); }\r\n\t\tthis.updateLights();\r\n\r\n\t}\r\n\r\n\tupdatePosition(){\r\n\t\tconst loopPos = mv3d.loopCoords(this.char._realX,this.char._realY);\r\n\t\tthis.x = loopPos.x;\r\n\t\tthis.y = loopPos.y;\r\n\r\n\t\tthis.spriteOrigin.position.set(0,0,0);\r\n\t\tthis.lightOrigin.position.set(0,0,0);\r\n\t\tthis.spriteOrigin.z = mv3d.LAYER_DIST*4;\r\n\t\tthis.lightOrigin.z = this.getConfig('lightHeight',mv3d.LIGHT_HEIGHT);\r\n\r\n\t\tconst billboardOffset = new Vector2(Math.sin(-mv3d.cameraNode.rotation.y),Math.cos(mv3d.cameraNode.rotation.y)).multiplyByFloats(0.45,0.45);\r\n\t\tconst lightOffset = this.getConfig('lightOffset',null);\r\n\t\tif(this.shape===mv3d.configurationShapes.SPRITE){\r\n\t\t\tthis.spriteOrigin.x=billboardOffset.x;\r\n\t\t\tthis.spriteOrigin.y=billboardOffset.y;\r\n\t\t\tthis.lightOrigin.x=billboardOffset.x;\r\n\t\t\tthis.lightOrigin.y=billboardOffset.y;\r\n\t\t}else if(!lightOffset){\r\n\t\t\tthis.lightOrigin.x=billboardOffset.x/2;\r\n\t\t\tthis.lightOrigin.y=billboardOffset.y/2;\r\n\t\t}\r\n\t\tif(lightOffset){\r\n\t\t\tthis.lightOrigin.x+=lightOffset.x;\r\n\t\t\tthis.lightOrigin.y+=lightOffset.y;\r\n\t\t}\r\n\r\n\t\tthis.spriteOrigin.x += this.getConfig('x',0);\r\n\t\tthis.spriteOrigin.y += this.getConfig('y',0);\r\n\t}\r\n\r\n\tupdateElevation(){\r\n\t\tlet newElevation = this.tileHeight;\r\n\t\tif(this.isVehicle || (this.isPlayer||this.isFollower)&&$gamePlayer.vehicle()){\r\n\t\t\tnewElevation += mv3d.getFloatHeight(Math.round(this.char._realX),Math.round(this.char._realY));\r\n\t\t\tif(this.char===$gameMap.vehicle('boat')){\r\n\t\t\t\tnewElevation += mv3d.BOAT_SETTINGS.zoff;\r\n\t\t\t}else if(this.char===$gameMap.vehicle('ship')){\r\n\t\t\t\tnewElevation += mv3d.SHIP_SETTINGS.zoff;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif(this.isAirship && $gamePlayer.vehicle()===this.char){\r\n\t\t\tif(!this.char._driving){\r\n\t\t\t\tthis.elevation += (newElevation-this.elevation)/10;\r\n\t\t\t}if(newElevation>=this.elevation){\r\n\t\t\t\tconst ascentSpeed = 100/Math.pow(1.5,mv3d.loadData('airship_ascentspeed',4));\r\n\t\t\t\tthis.elevation += (newElevation-this.elevation)/ascentSpeed;\r\n\t\t\t}else{\r\n\t\t\t\tif(!mv3d.vehicleObstructed(this.char,this.char.x,this.char.y,true)){\r\n\t\t\t\t\tconst descentSpeed = 100/Math.pow(1.5,mv3d.loadData('airship_descentspeed',2));\r\n\t\t\t\t\tthis.elevation += (newElevation-this.elevation)/descentSpeed;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.z = this.elevation;\r\n\t\t\tthis.z += mv3d.loadData('airship_height',mv3d.AIRSHIP_SETTINGS.height)*this.char._altitude/this.char.maxAltitude();\r\n\t\t}else if(this.char.isJumping()){\r\n\t\t\tlet jumpProgress = 1-(this.char._jumpCount/(this.char._jumpPeak*2));\r\n\t\t\tlet jumpHeight = Math.pow(jumpProgress-0.5,2)*-4+1;\r\n\t\t\tlet jumpDiff = Math.abs(this.char.mv3d_jumpHeightEnd - this.char.mv3d_jumpHeightStart);\r\n\t\t\tthis.z = this.char.mv3d_jumpHeightStart*(1-jumpProgress)\r\n\t\t\t+ this.char.mv3d_jumpHeightEnd*jumpProgress + jumpHeight*jumpDiff/2\r\n\t\t\t+this.char.jumpHeight()/tileSize();\r\n\t\t}else{\r\n\t\t\tthis.elevation=newElevation;\r\n\t\t\tthis.z=this.elevation;\r\n\t\t}\r\n\r\n\t\tif(this.isEvent){\r\n\t\t\tthis.z += this.getConfig('height',this.char._priorityType===2?mv3d.EVENT_HEIGHT:0);\r\n\t\t\tif(this.hasConfig('z')){\r\n\t\t\t\tthis.z=this.getConfig('z',0);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tupdateShadow(){\r\n\t\tlet shadowVisible = this.getConfig('shadow', this.shape!=mv3d.configurationShapes.FLAT );\r\n\r\n\t\tif(shadowVisible&&(this.isPlayer||this.isFollower)){\r\n\t\t\tconst myIndex = mv3d.characters.indexOf(this);\r\n\t\t\tif(myIndex>=0)\r\n\t\t\tfor (let i=myIndex+1; i<mv3d.characters.length; ++i){\r\n\t\t\t\tconst other = mv3d.characters[i];\r\n\t\t\t\tif(!other.shadow||!other.visible){ continue; }\r\n\t\t\t\tif(other.char._realX===this.char._realX&&other.char._realY===this.char._realY){\r\n\t\t\t\t\tshadowVisible=false;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(!this.shadow._isEnabled){\r\n\t\t\tif(shadowVisible){ this.shadow.setEnabled(true); }\r\n\t\t}else{\r\n\t\t\tif(!shadowVisible){ this.shadow.setEnabled(false); }\r\n\t\t}\r\n\t\tif(!shadowVisible){ return; }\r\n\r\n\t\tconst shadowBase = Math.min(0,this.getConfig('height',0));\r\n\t\tconst shadowDist = Math.max(this.z - this.tileHeight, shadowBase);\r\n\t\tconst shadowFadeDist = this.isAirship? mv3d.AIRSHIP_SETTINGS.shadowDist : mv3d.SHADOW_DIST;\r\n\t\tconst shadowStrength = Math.max(0,1-Math.abs(shadowDist)/shadowFadeDist);\r\n\t\tthis.shadow.z = -shadowDist;\r\n\t\tconst shadowScale = this.isAirship? mv3d.AIRSHIP_SETTINGS.shadowScale : this.getConfig('shadowScale',mv3d.SHADOW_SCALE);\r\n\t\tthis.shadow.scaling.setAll(shadowScale*shadowStrength);\r\n\t\tif(!this.shadow.isAnInstance){\r\n\t\t\tthis.shadow.visibility=shadowStrength-0.5*this.bush;//visibility doesn't work with instancing\r\n\t\t}\r\n\t}\r\n\r\n\tdispose(...args){\r\n\t\tsuper.dispose(...args);\r\n\t\tdelete this.char.mv3d_sprite;\r\n\t}\r\n}\r\n\r\nfor (const methodName of [\r\n\t'characterBlockX','characterBlockY','characterPatternX',\r\n\t'isImageChanged','patternWidth','patternHeight',\r\n\t'updateTileFrame','updateFrame',\r\n]){\r\n\tCharacter.prototype[methodName]=Sprite_Character.prototype[methodName];\r\n}","import mv3d from './mv3d.js';\r\n\r\nObject.assign(mv3d,{\r\n\tvehicleObstructed(vehicle,...args){\r\n\t\treturn vehicleObstructed.apply(vehicle,args);\r\n\t}\r\n});\r\n\r\nconst _characterBase_canPass = Game_CharacterBase.prototype.canPass\r\nGame_CharacterBase.prototype.canPass = function(x, y, d) {\r\n\tif(!_characterBase_canPass.apply(this,arguments)){\r\n\t\treturn false;\r\n\t}\r\n\tconst x2 = $gameMap.roundXWithDirection(x, d);\r\n\tconst y2 = $gameMap.roundYWithDirection(y, d);\r\n\tif(this===$gamePlayer){\r\n\t\tconst vehicle = this.vehicle();\r\n\t\tif(vehicle){\r\n\t\t\tconst obstructed = vehicleObstructed.call(vehicle,x2,y2,false);\r\n\t\t\tif(vehicle.isAirship()){\r\n\t\t\t\treturn !obstructed;\r\n\t\t\t}else if(obstructed){\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tif (this.isThrough() || this.isDebugThrough()) {\r\n\t\treturn true;\r\n\t}\r\n\tconst tileHeight1 = mv3d.getWalkHeight(x,y);\r\n\tconst tileHeight2 = mv3d.getWalkHeight(x2,y2);\r\n\tif(tileHeight1!==tileHeight2){ return false; }\r\n\treturn true;\r\n};\r\n\r\n// vehicles\r\n\r\nfunction vehicleNotObstructed(x, y, strict=true){\r\n\tif(!(this instanceof Game_Vehicle)){ throw \"This isn't a vehicle.\"; }\r\n\tif(!this.mv3d_sprite){ return true; }\r\n\tif(!this._driving){ return true; }\r\n\tif($gamePlayer.isDebugThrough()){ return true; }\r\n\tconst isAirship=this.isAirship();\r\n\tconst settings = mv3d[`${this._type.toUpperCase()}_SETTINGS`];\r\n\tconst big = mv3d.loadData( `${this._type}_big`, settings.big );\r\n\tlet altitude = 0.5;\r\n\tif(isAirship){\r\n\t\taltitude = mv3d.loadData('airship_height',mv3d.AIRSHIP_SETTINGS.height);\r\n\t}else{\r\n\t\taltitude += mv3d.getFloatHeight(x,y);\r\n\t}\r\n\tconst tileHeight = mv3d.getWalkHeight(x,y);\r\n\tlet posZ = this.mv3d_sprite.z;\r\n\tif('zoff' in settings){\r\n\t\tposZ-=settings.zoff;\r\n\t}\r\n\tif(tileHeight>posZ){ return false; }\r\n\tif(!big){ return true; }\r\n\tfor (let ox=-1;ox<=1;++ox)\r\n\tfor (let oy=-1;oy<=1;++oy){\r\n\t\tif(ox===0&&oy===0 || !strict&&ox&&oy){ continue; }\r\n\t\tconst tileHeight2 = mv3d.getWalkHeight(x+ox,y+oy);\r\n\t\tif(tileHeight2>tileHeight+altitude*!strict&&(strict||tileHeight2>posZ)){\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\treturn true;\r\n}\r\nfunction vehicleObstructed(){\r\n\treturn !vehicleNotObstructed.apply(this,arguments);\r\n}\r\n\r\nconst _airship_land_ok = Game_Map.prototype.isAirshipLandOk;\r\nGame_Map.prototype.isAirshipLandOk = function(x, y) {\r\n\tif(vehicleObstructed.call(this.airship(),x,y,true)){ return false; }\r\n\tif(mv3d.AIRSHIP_SETTINGS.bushLanding){\r\n\t\treturn this.checkPassage(x, y, 0x0f);\r\n\t}else{\r\n\t\treturn _airship_land_ok.apply(this,arguments);\r\n\t}\r\n\r\n};\r\n\r\nconst _player_updateVehicleGetOn = Game_Player.prototype.updateVehicleGetOn;\r\nGame_Player.prototype.updateVehicleGetOn = function() {\r\n\tconst vehicle = this.vehicle();\r\n\tconst speed = mv3d.loadData(`${vehicle._type}_speed`,vehicle._moveSpeed);\r\n\tthis.vehicle().setMoveSpeed(speed);\r\n\t_player_updateVehicleGetOn.apply(this,arguments);\r\n};\r\n\r\n// jump\r\n\r\nconst _charBase_jump = Game_CharacterBase.prototype.jump;\r\nGame_CharacterBase.prototype.jump = function(xPlus, yPlus) {\r\n\tthis.mv3d_jumpHeightStart = mv3d.getWalkHeight(this.x,this.y);\r\n\tthis.mv3d_jumpHeightEnd = mv3d.getWalkHeight(this.x+xPlus,this.y+yPlus);\r\n\t_charBase_jump.apply(this,arguments);\r\n};","import mv3d from './mv3d.js';\r\n\r\nconst gameMap_parallaxOx = Game_Map.prototype.parallaxOx;\r\nGame_Map.prototype.parallaxOx = function() {\r\n\tlet ox = gameMap_parallaxOx.apply(this,arguments);\r\n\tif(this._parallaxLoopX){\r\n\t\treturn ox - mv3d.blendCameraYaw.currentValue()*816/90;\r\n\t}\r\n\treturn ox;\r\n};\r\nconst gameMap_parallaxOy = Game_Map.prototype.parallaxOy;\r\nGame_Map.prototype.parallaxOy = function() {\r\n\tlet oy = gameMap_parallaxOy.apply(this,arguments);\r\n\tif(this._parallaxLoopY){\r\n\t\treturn oy - mv3d.blendCameraPitch.currentValue()*816/90;\r\n\t}\r\n    return oy;\r\n};\r\n\r\nGame_Map.prototype.setDisplayPos = function() { };\r\nGame_Map.prototype.scrollUp = function() { };\r\nGame_Map.prototype.scrollDown = function() { };\r\nGame_Map.prototype.scrollLeft = function() { };\r\nGame_Map.prototype.scrollRight = function() { };\r\nGame_Map.prototype.updateScroll = function() {\r\n    this._displayX = -mv3d.blendCameraYaw.currentValue()*816/3600;\r\n    this._displayY = -mv3d.blendCameraPitch.currentValue()*816/3600;\r\n};\r\n\r\nGame_CharacterBase.prototype.isNearTheScreen = function() {\r\n\treturn Math.abs(this.x - mv3d.cameraStick.position.x)<=mv3d.RENDER_DIST\r\n\t&& Math.abs(-this.y - mv3d.cameraStick.position.y)<=mv3d.RENDER_DIST;\r\n};\r\n"],"sourceRoot":""}